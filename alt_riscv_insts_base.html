<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>riscv_insts_base</title></head>
<body>
<h1>riscv_insts_base.sail (227/277) 82%</h1>
<code style="display: block">
/*&nbsp;******************************************************************&nbsp;*/<br>
/*&nbsp;This&nbsp;file&nbsp;specifies&nbsp;the&nbsp;instructions&nbsp;in&nbsp;the&nbsp;base&nbsp;integer&nbsp;set.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
<br>
<br>
/*&nbsp;******************************************************************&nbsp;*/<br>
union&nbsp;clause&nbsp;ast&nbsp;=&nbsp;UTYPE&nbsp;:&nbsp;(bits(20),&nbsp;regidx,&nbsp;uop)<br>
<br>
mapping&nbsp;encdec_uop&nbsp;:&nbsp;uop&nbsp;&lt;-&gt;&nbsp;bits(7)&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">RISCV_LUI</span>&nbsp;&nbsp;&nbsp;&lt;-&gt;&nbsp;0b0110111,<br>
&nbsp;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">RISCV_AUIPC</span>&nbsp;&lt;-&gt;&nbsp;0b0010111<br>
}<br>
<br>
mapping&nbsp;clause&nbsp;encdec&nbsp;=&nbsp;UTYPE(imm,&nbsp;rd,&nbsp;op)<br>
&nbsp;&nbsp;&lt;-&gt;&nbsp;imm&nbsp;@&nbsp;rd&nbsp;@&nbsp;encdec_uop(op)<br>
<br>
function&nbsp;clause&nbsp;<span style="background-color: hsl(220, 85%, 80%)">execute&nbsp;UTYPE(imm,&nbsp;rd,&nbsp;op)&nbsp;=&nbsp;<span style="background-color: hsl(220, 85%, 75%)">{<br>
&nbsp;&nbsp;let&nbsp;off&nbsp;:&nbsp;xlenbits&nbsp;=&nbsp;EXTS(imm&nbsp;@&nbsp;0x000);<br>
&nbsp;&nbsp;let&nbsp;ret&nbsp;:&nbsp;xlenbits&nbsp;=&nbsp;match&nbsp;op&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;RISCV_LUI&nbsp;&nbsp;&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 70%)">off</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;RISCV_AUIPC&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 70%)">get_arch_pc()&nbsp;+&nbsp;off</span><br>
&nbsp;&nbsp;};<br>
&nbsp;&nbsp;X(rd)&nbsp;=&nbsp;ret;<br>
&nbsp;&nbsp;RETIRE_SUCCESS<br>
}</span></span><br>
<br>
mapping&nbsp;utype_mnemonic&nbsp;:&nbsp;uop&nbsp;&lt;-&gt;&nbsp;string&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;RISCV_LUI&nbsp;&nbsp;&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">&quot;lui&quot;</span>,<br>
&nbsp;&nbsp;RISCV_AUIPC&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">&quot;auipc&quot;</span><br>
}<br>
<br>
mapping&nbsp;clause&nbsp;assembly&nbsp;=&nbsp;UTYPE(imm,&nbsp;rd,&nbsp;op)<br>
&nbsp;&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">utype_mnemonic(op)&nbsp;^&nbsp;spc()&nbsp;^&nbsp;reg_name(rd)&nbsp;^&nbsp;sep()&nbsp;^&nbsp;hex_bits_20(imm)</span><br>
<br>
/*&nbsp;******************************************************************&nbsp;*/<br>
union&nbsp;clause&nbsp;ast&nbsp;=&nbsp;RISCV_JAL&nbsp;:&nbsp;(bits(21),&nbsp;regidx)<br>
<br>
mapping&nbsp;clause&nbsp;encdec&nbsp;=&nbsp;<span style="background-color: hsl(220, 85%, 80%)">RISCV_JAL(imm_19&nbsp;@&nbsp;imm_7_0&nbsp;@&nbsp;imm_8&nbsp;@&nbsp;imm_18_13&nbsp;@&nbsp;imm_12_9&nbsp;@&nbsp;0b0,&nbsp;rd)</span><br>
&nbsp;&nbsp;&lt;-&gt;&nbsp;imm_19&nbsp;:&nbsp;bits(1)&nbsp;@&nbsp;imm_18_13&nbsp;:&nbsp;bits(6)&nbsp;@&nbsp;imm_12_9&nbsp;:&nbsp;bits(4)&nbsp;@&nbsp;imm_8&nbsp;:&nbsp;bits(1)&nbsp;@&nbsp;imm_7_0&nbsp;:&nbsp;bits(8)&nbsp;@&nbsp;rd&nbsp;@&nbsp;0b1101111<br>
<br>
/*<br>
ideally&nbsp;we&nbsp;want&nbsp;some&nbsp;syntax&nbsp;like<br>
<br>
mapping&nbsp;clause&nbsp;encdec&nbsp;=&nbsp;RISCV_JAL(imm&nbsp;@&nbsp;0b0,&nbsp;rd)&nbsp;&lt;-&gt;&nbsp;imm[19]&nbsp;@&nbsp;imm[9..0]&nbsp;@&nbsp;imm[10]&nbsp;@&nbsp;imm[18..11]&nbsp;@&nbsp;rd&nbsp;@&nbsp;0b1101111<br>
<br>
match&nbsp;bv&nbsp;{<br>
&nbsp;&nbsp;imm[19]&nbsp;@&nbsp;imm[9..0]&nbsp;@&nbsp;imm[10]&nbsp;@&nbsp;imm[18..11]&nbsp;-&gt;&nbsp;imm&nbsp;@&nbsp;0b0<br>
}<br>
<br>
but&nbsp;this&nbsp;is&nbsp;difficult<br>
*/<br>
<br>
function&nbsp;clause&nbsp;execute&nbsp;(RISCV_JAL(imm,&nbsp;rd))&nbsp;=&nbsp;<span style="background-color: hsl(220, 85%, 80%)">{<br>
&nbsp;&nbsp;let&nbsp;t&nbsp;:&nbsp;xlenbits&nbsp;=&nbsp;PC&nbsp;+&nbsp;EXTS(imm);<br>
&nbsp;&nbsp;/*&nbsp;Extensions&nbsp;get&nbsp;the&nbsp;first&nbsp;checks&nbsp;on&nbsp;the&nbsp;prospective&nbsp;target&nbsp;address.&nbsp;*/<br>
&nbsp;&nbsp;match&nbsp;ext_control_check_pc(t)&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;Ext_ControlAddr_Error(e)&nbsp;=&gt;&nbsp;<span style="background-color: hsl(50, 85%, 80%)">{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ext_handle_control_check_error(e);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RETIRE_FAIL<br>
&nbsp;&nbsp;&nbsp;&nbsp;}</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;Ext_ControlAddr_OK(target)&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 75%)">{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;Perform&nbsp;standard&nbsp;alignment&nbsp;check&nbsp;*/<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;bit_to_bool(target[1])&nbsp;&&nbsp;(~&nbsp;(haveRVC()))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;<span style="background-color: hsl(50, 85%, 80%)">{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;handle_mem_exception(target,&nbsp;E_Fetch_Addr_Align());<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RETIRE_FAIL<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>&nbsp;else&nbsp;<span style="background-color: hsl(220, 85%, 70%)">{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;X(rd)&nbsp;=&nbsp;get_next_pc();<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set_next_pc(target);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RETIRE_SUCCESS<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
&nbsp;&nbsp;}<br>
}</span><br>
<br>
/*&nbsp;TODO:&nbsp;handle&nbsp;2-byte-alignment&nbsp;in&nbsp;mappings&nbsp;*/<br>
<br>
mapping&nbsp;clause&nbsp;assembly&nbsp;=&nbsp;RISCV_JAL(imm,&nbsp;rd)<br>
&nbsp;&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">&quot;jal&quot;&nbsp;^&nbsp;spc()&nbsp;^&nbsp;reg_name(rd)&nbsp;^&nbsp;sep()&nbsp;^&nbsp;hex_bits_21(imm)</span><br>
<br>
/*&nbsp;******************************************************************&nbsp;*/<br>
union&nbsp;clause&nbsp;ast&nbsp;=&nbsp;RISCV_JALR&nbsp;:&nbsp;(bits(12),&nbsp;regidx,&nbsp;regidx)<br>
<br>
mapping&nbsp;clause&nbsp;encdec&nbsp;=&nbsp;<span style="background-color: hsl(220, 85%, 80%)">RISCV_JALR(imm,&nbsp;rs1,&nbsp;rd)</span><br>
&nbsp;&nbsp;&lt;-&gt;&nbsp;imm&nbsp;@&nbsp;rs1&nbsp;@&nbsp;0b000&nbsp;@&nbsp;rd&nbsp;@&nbsp;0b1100111<br>
<br>
mapping&nbsp;clause&nbsp;assembly&nbsp;=&nbsp;RISCV_JALR(imm,&nbsp;rs1,&nbsp;rd)<br>
&nbsp;&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">&quot;jalr&quot;&nbsp;^&nbsp;spc()&nbsp;^&nbsp;reg_name(rd)&nbsp;^&nbsp;sep()&nbsp;^&nbsp;reg_name(rs1)&nbsp;^&nbsp;sep()&nbsp;^&nbsp;hex_bits_12(imm)</span><br>
<br>
/*&nbsp;see&nbsp;riscv_jalr_seq.sail&nbsp;or&nbsp;riscv_jalr_rmem.sail&nbsp;for&nbsp;the&nbsp;execute&nbsp;clause.&nbsp;*/<br>
<br>
/*&nbsp;******************************************************************&nbsp;*/<br>
union&nbsp;clause&nbsp;ast&nbsp;=&nbsp;BTYPE&nbsp;:&nbsp;(bits(13),&nbsp;regidx,&nbsp;regidx,&nbsp;bop)<br>
<br>
mapping&nbsp;encdec_bop&nbsp;:&nbsp;bop&nbsp;&lt;-&gt;&nbsp;bits(3)&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">RISCV_BEQ</span>&nbsp;&nbsp;&lt;-&gt;&nbsp;0b000,<br>
&nbsp;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">RISCV_BNE</span>&nbsp;&nbsp;&lt;-&gt;&nbsp;0b001,<br>
&nbsp;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">RISCV_BLT</span>&nbsp;&nbsp;&lt;-&gt;&nbsp;0b100,<br>
&nbsp;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">RISCV_BGE</span>&nbsp;&nbsp;&lt;-&gt;&nbsp;0b101,<br>
&nbsp;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">RISCV_BLTU</span>&nbsp;&lt;-&gt;&nbsp;0b110,<br>
&nbsp;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">RISCV_BGEU</span>&nbsp;&lt;-&gt;&nbsp;0b111<br>
}<br>
<br>
mapping&nbsp;clause&nbsp;encdec&nbsp;=&nbsp;BTYPE(imm7_6&nbsp;@&nbsp;imm5_0&nbsp;@&nbsp;imm7_5_0&nbsp;@&nbsp;imm5_4_1&nbsp;@&nbsp;0b0,&nbsp;rs2,&nbsp;rs1,&nbsp;op)<br>
&nbsp;&nbsp;&lt;-&gt;&nbsp;imm7_6&nbsp;:&nbsp;bits(1)&nbsp;@&nbsp;imm7_5_0&nbsp;:&nbsp;bits(6)&nbsp;@&nbsp;rs2&nbsp;@&nbsp;rs1&nbsp;@&nbsp;encdec_bop(op)&nbsp;@&nbsp;imm5_4_1&nbsp;:&nbsp;bits(4)&nbsp;@&nbsp;imm5_0&nbsp;:&nbsp;bits(1)&nbsp;@&nbsp;0b1100011<br>
<br>
function&nbsp;clause&nbsp;execute&nbsp;(BTYPE(imm,&nbsp;rs2,&nbsp;rs1,&nbsp;op))&nbsp;=&nbsp;<span style="background-color: hsl(220, 85%, 80%)">{<br>
&nbsp;&nbsp;let&nbsp;rs1_val&nbsp;=&nbsp;X(rs1);<br>
&nbsp;&nbsp;let&nbsp;rs2_val&nbsp;=&nbsp;X(rs2);<br>
&nbsp;&nbsp;let&nbsp;taken&nbsp;:&nbsp;bool&nbsp;=&nbsp;match&nbsp;op&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;RISCV_BEQ&nbsp;&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 75%)">rs1_val&nbsp;==&nbsp;rs2_val</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;RISCV_BNE&nbsp;&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 75%)">rs1_val&nbsp;!=&nbsp;rs2_val</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;RISCV_BLT&nbsp;&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 75%)">rs1_val&nbsp;&lt;_s&nbsp;rs2_val</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;RISCV_BGE&nbsp;&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 75%)">rs1_val&nbsp;&gt;=_s&nbsp;rs2_val</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;RISCV_BLTU&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 75%)">rs1_val&nbsp;&lt;_u&nbsp;rs2_val</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;RISCV_BGEU&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 75%)">rs1_val&nbsp;&gt;=_u&nbsp;rs2_val</span><br>
&nbsp;&nbsp;};<br>
&nbsp;&nbsp;let&nbsp;t&nbsp;:&nbsp;xlenbits&nbsp;=&nbsp;PC&nbsp;+&nbsp;EXTS(imm);<br>
&nbsp;&nbsp;if&nbsp;taken&nbsp;then&nbsp;<span style="background-color: hsl(220, 85%, 75%)">{<br>
&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;Extensions&nbsp;get&nbsp;the&nbsp;first&nbsp;checks&nbsp;on&nbsp;the&nbsp;prospective&nbsp;target&nbsp;address.&nbsp;*/<br>
&nbsp;&nbsp;&nbsp;&nbsp;match&nbsp;ext_control_check_pc(t)&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Ext_ControlAddr_Error(e)&nbsp;=&gt;&nbsp;<span style="background-color: hsl(50, 85%, 80%)">{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ext_handle_control_check_error(e);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RETIRE_FAIL<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Ext_ControlAddr_OK(target)&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 70%)">{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;bit_to_bool(target[1])&nbsp;&&nbsp;(~&nbsp;(haveRVC()))&nbsp;then&nbsp;<span style="background-color: hsl(50, 85%, 80%)">{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;handle_mem_exception(target,&nbsp;E_Fetch_Addr_Align());<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RETIRE_FAIL;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>&nbsp;else&nbsp;<span style="background-color: hsl(220, 85%, 65%)">{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set_next_pc(target);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RETIRE_SUCCESS<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;}</span>&nbsp;else&nbsp;<span style="background-color: hsl(220, 85%, 75%)">RETIRE_SUCCESS</span><br>
}</span><br>
<br>
mapping&nbsp;btype_mnemonic&nbsp;:&nbsp;bop&nbsp;&lt;-&gt;&nbsp;string&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;RISCV_BEQ&nbsp;&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">&quot;beq&quot;</span>,<br>
&nbsp;&nbsp;RISCV_BNE&nbsp;&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">&quot;bne&quot;</span>,<br>
&nbsp;&nbsp;RISCV_BLT&nbsp;&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">&quot;blt&quot;</span>,<br>
&nbsp;&nbsp;RISCV_BGE&nbsp;&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">&quot;bge&quot;</span>,<br>
&nbsp;&nbsp;RISCV_BLTU&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">&quot;bltu&quot;</span>,<br>
&nbsp;&nbsp;RISCV_BGEU&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">&quot;bgeu&quot;</span><br>
}<br>
<br>
mapping&nbsp;clause&nbsp;assembly&nbsp;=&nbsp;BTYPE(imm,&nbsp;rs2,&nbsp;rs1,&nbsp;op)<br>
&nbsp;&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">btype_mnemonic(op)&nbsp;^&nbsp;spc()&nbsp;^&nbsp;reg_name(rs1)&nbsp;^&nbsp;sep()&nbsp;^&nbsp;reg_name(rs2)&nbsp;^&nbsp;sep()&nbsp;^&nbsp;hex_bits_13(imm)</span><br>
<br>
/*&nbsp;******************************************************************&nbsp;*/<br>
union&nbsp;clause&nbsp;ast&nbsp;=&nbsp;ITYPE&nbsp;:&nbsp;(bits(12),&nbsp;regidx,&nbsp;regidx,&nbsp;iop)<br>
<br>
mapping&nbsp;encdec_iop&nbsp;:&nbsp;iop&nbsp;&lt;-&gt;&nbsp;bits(3)&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">RISCV_ADDI</span>&nbsp;&nbsp;&lt;-&gt;&nbsp;0b000,<br>
&nbsp;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">RISCV_SLTI</span>&nbsp;&nbsp;&lt;-&gt;&nbsp;0b010,<br>
&nbsp;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">RISCV_SLTIU</span>&nbsp;&lt;-&gt;&nbsp;0b011,<br>
&nbsp;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">RISCV_ANDI</span>&nbsp;&nbsp;&lt;-&gt;&nbsp;0b111,<br>
&nbsp;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">RISCV_ORI</span>&nbsp;&nbsp;&nbsp;&lt;-&gt;&nbsp;0b110,<br>
&nbsp;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">RISCV_XORI</span>&nbsp;&nbsp;&lt;-&gt;&nbsp;0b100<br>
}<br>
<br>
mapping&nbsp;clause&nbsp;encdec&nbsp;=&nbsp;ITYPE(imm,&nbsp;rs1,&nbsp;rd,&nbsp;op)<br>
&nbsp;&nbsp;&lt;-&gt;&nbsp;imm&nbsp;@&nbsp;rs1&nbsp;@&nbsp;encdec_iop(op)&nbsp;@&nbsp;rd&nbsp;@&nbsp;0b0010011<br>
<br>
function&nbsp;clause&nbsp;execute&nbsp;(ITYPE&nbsp;(imm,&nbsp;rs1,&nbsp;rd,&nbsp;op))&nbsp;=&nbsp;<span style="background-color: hsl(220, 85%, 80%)">{<br>
&nbsp;&nbsp;let&nbsp;rs1_val&nbsp;=&nbsp;X(rs1);<br>
&nbsp;&nbsp;let&nbsp;immext&nbsp;:&nbsp;xlenbits&nbsp;=&nbsp;EXTS(imm);<br>
&nbsp;&nbsp;let&nbsp;result&nbsp;:&nbsp;xlenbits&nbsp;=&nbsp;match&nbsp;op&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;RISCV_ADDI&nbsp;&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 75%)">rs1_val&nbsp;+&nbsp;immext</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;RISCV_SLTI&nbsp;&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 75%)">EXTZ(bool_to_bits(rs1_val&nbsp;&lt;_s&nbsp;immext))</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;RISCV_SLTIU&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 75%)">EXTZ(bool_to_bits(rs1_val&nbsp;&lt;_u&nbsp;immext))</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;RISCV_ANDI&nbsp;&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 75%)">rs1_val&nbsp;&&nbsp;immext</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;RISCV_ORI&nbsp;&nbsp;&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 75%)">rs1_val&nbsp;|&nbsp;immext</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;RISCV_XORI&nbsp;&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 75%)">rs1_val&nbsp;^&nbsp;immext</span><br>
&nbsp;&nbsp;};<br>
&nbsp;&nbsp;X(rd)&nbsp;=&nbsp;result;<br>
&nbsp;&nbsp;RETIRE_SUCCESS<br>
}</span><br>
<br>
mapping&nbsp;itype_mnemonic&nbsp;:&nbsp;iop&nbsp;&lt;-&gt;&nbsp;string&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;RISCV_ADDI&nbsp;&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">&quot;addi&quot;</span>,<br>
&nbsp;&nbsp;RISCV_SLTI&nbsp;&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">&quot;slti&quot;</span>,<br>
&nbsp;&nbsp;RISCV_SLTIU&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">&quot;sltiu&quot;</span>,<br>
&nbsp;&nbsp;RISCV_XORI&nbsp;&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">&quot;xori&quot;</span>,<br>
&nbsp;&nbsp;RISCV_ORI&nbsp;&nbsp;&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">&quot;ori&quot;</span>,<br>
&nbsp;&nbsp;RISCV_ANDI&nbsp;&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">&quot;andi&quot;</span><br>
}<br>
<br>
mapping&nbsp;clause&nbsp;assembly&nbsp;=&nbsp;ITYPE(imm,&nbsp;rs1,&nbsp;rd,&nbsp;op)<br>
&nbsp;&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">itype_mnemonic(op)&nbsp;^&nbsp;spc()&nbsp;^&nbsp;reg_name(rd)&nbsp;^&nbsp;sep()&nbsp;^&nbsp;reg_name(rs1)&nbsp;^&nbsp;sep()&nbsp;^&nbsp;hex_bits_12(imm)</span><br>
<br>
/*&nbsp;******************************************************************&nbsp;*/<br>
union&nbsp;clause&nbsp;ast&nbsp;=&nbsp;SHIFTIOP&nbsp;:&nbsp;(bits(6),&nbsp;regidx,&nbsp;regidx,&nbsp;sop)<br>
<br>
mapping&nbsp;encdec_sop&nbsp;:&nbsp;sop&nbsp;&lt;-&gt;&nbsp;bits(3)&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;RISCV_SLLI&nbsp;&lt;-&gt;&nbsp;0b001,<br>
&nbsp;&nbsp;RISCV_SRLI&nbsp;&lt;-&gt;&nbsp;0b101,<br>
&nbsp;&nbsp;RISCV_SRAI&nbsp;&lt;-&gt;&nbsp;0b101<br>
}<br>
<br>
mapping&nbsp;clause&nbsp;encdec&nbsp;=&nbsp;<span style="background-color: hsl(220, 85%, 80%)">SHIFTIOP(shamt,&nbsp;rs1,&nbsp;rd,&nbsp;RISCV_SLLI)</span>&nbsp;&lt;-&gt;&nbsp;0b000000&nbsp;@&nbsp;shamt&nbsp;@&nbsp;rs1&nbsp;@&nbsp;0b001&nbsp;@&nbsp;rd&nbsp;@&nbsp;0b0010011&nbsp;if&nbsp;sizeof(xlen)&nbsp;==&nbsp;64&nbsp;|&nbsp;shamt[5]&nbsp;==&nbsp;bitzero<br>
mapping&nbsp;clause&nbsp;encdec&nbsp;=&nbsp;<span style="background-color: hsl(220, 85%, 80%)">SHIFTIOP(shamt,&nbsp;rs1,&nbsp;rd,&nbsp;RISCV_SRLI)</span>&nbsp;&lt;-&gt;&nbsp;0b000000&nbsp;@&nbsp;shamt&nbsp;@&nbsp;rs1&nbsp;@&nbsp;0b101&nbsp;@&nbsp;rd&nbsp;@&nbsp;0b0010011&nbsp;if&nbsp;sizeof(xlen)&nbsp;==&nbsp;64&nbsp;|&nbsp;shamt[5]&nbsp;==&nbsp;bitzero<br>
mapping&nbsp;clause&nbsp;encdec&nbsp;=&nbsp;<span style="background-color: hsl(220, 85%, 80%)">SHIFTIOP(shamt,&nbsp;rs1,&nbsp;rd,&nbsp;RISCV_SRAI)</span>&nbsp;&lt;-&gt;&nbsp;0b010000&nbsp;@&nbsp;shamt&nbsp;@&nbsp;rs1&nbsp;@&nbsp;0b101&nbsp;@&nbsp;rd&nbsp;@&nbsp;0b0010011&nbsp;if&nbsp;sizeof(xlen)&nbsp;==&nbsp;64&nbsp;|&nbsp;shamt[5]&nbsp;==&nbsp;bitzero<br>
<br>
function&nbsp;clause&nbsp;execute&nbsp;(SHIFTIOP(shamt,&nbsp;rs1,&nbsp;rd,&nbsp;op))&nbsp;=&nbsp;<span style="background-color: hsl(220, 85%, 80%)">{<br>
&nbsp;&nbsp;let&nbsp;rs1_val&nbsp;=&nbsp;X(rs1);<br>
&nbsp;&nbsp;/*&nbsp;the&nbsp;decoder&nbsp;guard&nbsp;should&nbsp;ensure&nbsp;that&nbsp;shamt[5]&nbsp;=&nbsp;0&nbsp;for&nbsp;RV32&nbsp;*/<br>
&nbsp;&nbsp;let&nbsp;result&nbsp;:&nbsp;xlenbits&nbsp;=&nbsp;match&nbsp;op&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;RISCV_SLLI&nbsp;=&gt;&nbsp;if&nbsp;&nbsp;&nbsp;sizeof(xlen)&nbsp;==&nbsp;32<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;rs1_val&nbsp;&lt;&lt;&nbsp;shamt[4..0]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;<span style="background-color: hsl(220, 85%, 75%)">rs1_val&nbsp;&lt;&lt;&nbsp;shamt</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;RISCV_SRLI&nbsp;=&gt;&nbsp;if&nbsp;&nbsp;&nbsp;sizeof(xlen)&nbsp;==&nbsp;32<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;rs1_val&nbsp;&gt;&gt;&nbsp;shamt[4..0]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;<span style="background-color: hsl(220, 85%, 75%)">rs1_val&nbsp;&gt;&gt;&nbsp;shamt</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;RISCV_SRAI&nbsp;=&gt;&nbsp;if&nbsp;&nbsp;&nbsp;sizeof(xlen)&nbsp;==&nbsp;32<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;shift_right_arith32(rs1_val,&nbsp;shamt[4..0])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;<span style="background-color: hsl(220, 85%, 75%)">shift_right_arith64(rs1_val,&nbsp;shamt)</span><br>
&nbsp;&nbsp;};<br>
&nbsp;&nbsp;X(rd)&nbsp;=&nbsp;result;<br>
&nbsp;&nbsp;RETIRE_SUCCESS<br>
}</span><br>
<br>
mapping&nbsp;shiftiop_mnemonic&nbsp;:&nbsp;sop&nbsp;&lt;-&gt;&nbsp;string&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;RISCV_SLLI&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">&quot;slli&quot;</span>,<br>
&nbsp;&nbsp;RISCV_SRLI&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">&quot;srli&quot;</span>,<br>
&nbsp;&nbsp;RISCV_SRAI&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">&quot;srai&quot;</span><br>
}<br>
<br>
mapping&nbsp;clause&nbsp;assembly&nbsp;=&nbsp;SHIFTIOP(shamt,&nbsp;rs1,&nbsp;rd,&nbsp;op)<br>
&nbsp;&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">shiftiop_mnemonic(op)&nbsp;^&nbsp;spc()&nbsp;^&nbsp;reg_name(rd)&nbsp;^&nbsp;sep()&nbsp;^&nbsp;reg_name(rs1)&nbsp;^&nbsp;sep()&nbsp;^&nbsp;hex_bits_6(shamt)</span><br>
<br>
/*&nbsp;******************************************************************&nbsp;*/<br>
union&nbsp;clause&nbsp;ast&nbsp;=&nbsp;RTYPE&nbsp;:&nbsp;(regidx,&nbsp;regidx,&nbsp;regidx,&nbsp;rop)<br>
<br>
mapping&nbsp;clause&nbsp;encdec&nbsp;=&nbsp;<span style="background-color: hsl(220, 85%, 80%)">RTYPE(rs2,&nbsp;rs1,&nbsp;rd,&nbsp;RISCV_ADD)</span>&nbsp;&nbsp;&lt;-&gt;&nbsp;0b0000000&nbsp;@&nbsp;rs2&nbsp;@&nbsp;rs1&nbsp;@&nbsp;0b000&nbsp;@&nbsp;rd&nbsp;@&nbsp;0b0110011<br>
mapping&nbsp;clause&nbsp;encdec&nbsp;=&nbsp;<span style="background-color: hsl(220, 85%, 80%)">RTYPE(rs2,&nbsp;rs1,&nbsp;rd,&nbsp;RISCV_SLT)</span>&nbsp;&nbsp;&lt;-&gt;&nbsp;0b0000000&nbsp;@&nbsp;rs2&nbsp;@&nbsp;rs1&nbsp;@&nbsp;0b010&nbsp;@&nbsp;rd&nbsp;@&nbsp;0b0110011<br>
mapping&nbsp;clause&nbsp;encdec&nbsp;=&nbsp;<span style="background-color: hsl(220, 85%, 80%)">RTYPE(rs2,&nbsp;rs1,&nbsp;rd,&nbsp;RISCV_SLTU)</span>&nbsp;&lt;-&gt;&nbsp;0b0000000&nbsp;@&nbsp;rs2&nbsp;@&nbsp;rs1&nbsp;@&nbsp;0b011&nbsp;@&nbsp;rd&nbsp;@&nbsp;0b0110011<br>
mapping&nbsp;clause&nbsp;encdec&nbsp;=&nbsp;<span style="background-color: hsl(220, 85%, 80%)">RTYPE(rs2,&nbsp;rs1,&nbsp;rd,&nbsp;RISCV_AND)</span>&nbsp;&nbsp;&lt;-&gt;&nbsp;0b0000000&nbsp;@&nbsp;rs2&nbsp;@&nbsp;rs1&nbsp;@&nbsp;0b111&nbsp;@&nbsp;rd&nbsp;@&nbsp;0b0110011<br>
mapping&nbsp;clause&nbsp;encdec&nbsp;=&nbsp;<span style="background-color: hsl(220, 85%, 80%)">RTYPE(rs2,&nbsp;rs1,&nbsp;rd,&nbsp;RISCV_OR)</span>&nbsp;&nbsp;&nbsp;&lt;-&gt;&nbsp;0b0000000&nbsp;@&nbsp;rs2&nbsp;@&nbsp;rs1&nbsp;@&nbsp;0b110&nbsp;@&nbsp;rd&nbsp;@&nbsp;0b0110011<br>
mapping&nbsp;clause&nbsp;encdec&nbsp;=&nbsp;<span style="background-color: hsl(220, 85%, 80%)">RTYPE(rs2,&nbsp;rs1,&nbsp;rd,&nbsp;RISCV_XOR)</span>&nbsp;&nbsp;&lt;-&gt;&nbsp;0b0000000&nbsp;@&nbsp;rs2&nbsp;@&nbsp;rs1&nbsp;@&nbsp;0b100&nbsp;@&nbsp;rd&nbsp;@&nbsp;0b0110011<br>
mapping&nbsp;clause&nbsp;encdec&nbsp;=&nbsp;<span style="background-color: hsl(220, 85%, 80%)">RTYPE(rs2,&nbsp;rs1,&nbsp;rd,&nbsp;RISCV_SLL)</span>&nbsp;&nbsp;&lt;-&gt;&nbsp;0b0000000&nbsp;@&nbsp;rs2&nbsp;@&nbsp;rs1&nbsp;@&nbsp;0b001&nbsp;@&nbsp;rd&nbsp;@&nbsp;0b0110011<br>
mapping&nbsp;clause&nbsp;encdec&nbsp;=&nbsp;<span style="background-color: hsl(220, 85%, 80%)">RTYPE(rs2,&nbsp;rs1,&nbsp;rd,&nbsp;RISCV_SRL)</span>&nbsp;&nbsp;&lt;-&gt;&nbsp;0b0000000&nbsp;@&nbsp;rs2&nbsp;@&nbsp;rs1&nbsp;@&nbsp;0b101&nbsp;@&nbsp;rd&nbsp;@&nbsp;0b0110011<br>
mapping&nbsp;clause&nbsp;encdec&nbsp;=&nbsp;<span style="background-color: hsl(220, 85%, 80%)">RTYPE(rs2,&nbsp;rs1,&nbsp;rd,&nbsp;RISCV_SUB)</span>&nbsp;&nbsp;&lt;-&gt;&nbsp;0b0100000&nbsp;@&nbsp;rs2&nbsp;@&nbsp;rs1&nbsp;@&nbsp;0b000&nbsp;@&nbsp;rd&nbsp;@&nbsp;0b0110011<br>
mapping&nbsp;clause&nbsp;encdec&nbsp;=&nbsp;<span style="background-color: hsl(220, 85%, 80%)">RTYPE(rs2,&nbsp;rs1,&nbsp;rd,&nbsp;RISCV_SRA)</span>&nbsp;&nbsp;&lt;-&gt;&nbsp;0b0100000&nbsp;@&nbsp;rs2&nbsp;@&nbsp;rs1&nbsp;@&nbsp;0b101&nbsp;@&nbsp;rd&nbsp;@&nbsp;0b0110011<br>
<br>
function&nbsp;clause&nbsp;execute&nbsp;(RTYPE(rs2,&nbsp;rs1,&nbsp;rd,&nbsp;op))&nbsp;=&nbsp;<span style="background-color: hsl(220, 85%, 80%)">{<br>
&nbsp;&nbsp;let&nbsp;rs1_val&nbsp;=&nbsp;X(rs1);<br>
&nbsp;&nbsp;let&nbsp;rs2_val&nbsp;=&nbsp;X(rs2);<br>
&nbsp;&nbsp;let&nbsp;result&nbsp;:&nbsp;xlenbits&nbsp;=&nbsp;match&nbsp;op&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;RISCV_ADD&nbsp;&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 75%)">rs1_val&nbsp;+&nbsp;rs2_val</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;RISCV_SLT&nbsp;&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 75%)">EXTZ(bool_to_bits(rs1_val&nbsp;&lt;_s&nbsp;rs2_val))</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;RISCV_SLTU&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 75%)">EXTZ(bool_to_bits(rs1_val&nbsp;&lt;_u&nbsp;rs2_val))</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;RISCV_AND&nbsp;&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 75%)">rs1_val&nbsp;&&nbsp;rs2_val</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;RISCV_OR&nbsp;&nbsp;&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 75%)">rs1_val&nbsp;|&nbsp;rs2_val</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;RISCV_XOR&nbsp;&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 75%)">rs1_val&nbsp;^&nbsp;rs2_val</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;RISCV_SLL&nbsp;&nbsp;=&gt;&nbsp;if&nbsp;&nbsp;&nbsp;sizeof(xlen)&nbsp;==&nbsp;32<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;rs1_val&nbsp;&lt;&lt;&nbsp;(rs2_val[4..0])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;<span style="background-color: hsl(220, 85%, 75%)">rs1_val&nbsp;&lt;&lt;&nbsp;(rs2_val[5..0])</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;RISCV_SRL&nbsp;&nbsp;=&gt;&nbsp;if&nbsp;&nbsp;&nbsp;sizeof(xlen)&nbsp;==&nbsp;32<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;rs1_val&nbsp;&gt;&gt;&nbsp;(rs2_val[4..0])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;<span style="background-color: hsl(220, 85%, 75%)">rs1_val&nbsp;&gt;&gt;&nbsp;(rs2_val[5..0])</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;RISCV_SUB&nbsp;&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 75%)">rs1_val&nbsp;-&nbsp;rs2_val</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;RISCV_SRA&nbsp;&nbsp;=&gt;&nbsp;if&nbsp;&nbsp;&nbsp;sizeof(xlen)&nbsp;==&nbsp;32<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;shift_right_arith32(rs1_val,&nbsp;rs2_val[4..0])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;<span style="background-color: hsl(220, 85%, 75%)">shift_right_arith64(rs1_val,&nbsp;rs2_val[5..0])</span><br>
&nbsp;&nbsp;};<br>
&nbsp;&nbsp;X(rd)&nbsp;=&nbsp;result;<br>
&nbsp;&nbsp;RETIRE_SUCCESS<br>
}</span><br>
<br>
mapping&nbsp;rtype_mnemonic&nbsp;:&nbsp;rop&nbsp;&lt;-&gt;&nbsp;string&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;RISCV_ADD&nbsp;&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">&quot;add&quot;</span>,<br>
&nbsp;&nbsp;RISCV_SLT&nbsp;&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">&quot;slt&quot;</span>,<br>
&nbsp;&nbsp;RISCV_SLTU&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">&quot;sltu&quot;</span>,<br>
&nbsp;&nbsp;RISCV_AND&nbsp;&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">&quot;and&quot;</span>,<br>
&nbsp;&nbsp;RISCV_OR&nbsp;&nbsp;&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">&quot;or&quot;</span>,<br>
&nbsp;&nbsp;RISCV_XOR&nbsp;&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">&quot;xor&quot;</span>,<br>
&nbsp;&nbsp;RISCV_SLL&nbsp;&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">&quot;sll&quot;</span>,<br>
&nbsp;&nbsp;RISCV_SRL&nbsp;&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">&quot;srl&quot;</span>,<br>
&nbsp;&nbsp;RISCV_SUB&nbsp;&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">&quot;sub&quot;</span>,<br>
&nbsp;&nbsp;RISCV_SRA&nbsp;&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">&quot;sra&quot;</span><br>
}<br>
<br>
mapping&nbsp;clause&nbsp;assembly&nbsp;=&nbsp;RTYPE(rs2,&nbsp;rs1,&nbsp;rd,&nbsp;op)<br>
&nbsp;&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">rtype_mnemonic(op)&nbsp;^&nbsp;spc()&nbsp;^&nbsp;reg_name(rd)&nbsp;^&nbsp;sep()&nbsp;^&nbsp;reg_name(rs1)&nbsp;^&nbsp;sep()&nbsp;^&nbsp;reg_name(rs2)</span><br>
<br>
/*&nbsp;******************************************************************&nbsp;*/<br>
union&nbsp;clause&nbsp;ast&nbsp;=&nbsp;LOAD&nbsp;:&nbsp;(bits(12),&nbsp;regidx,&nbsp;regidx,&nbsp;bool,&nbsp;word_width,&nbsp;bool,&nbsp;bool)<br>
<br>
/*&nbsp;unsigned&nbsp;loads&nbsp;are&nbsp;only&nbsp;present&nbsp;for&nbsp;widths&nbsp;strictly&nbsp;less&nbsp;than&nbsp;xlen,<br>
&nbsp;&nbsp;&nbsp;signed&nbsp;loads&nbsp;also&nbsp;present&nbsp;for&nbsp;widths&nbsp;equal&nbsp;to&nbsp;xlen&nbsp;*/<br>
mapping&nbsp;clause&nbsp;encdec&nbsp;=&nbsp;LOAD(imm,&nbsp;rs1,&nbsp;rd,&nbsp;is_unsigned,&nbsp;size,&nbsp;false,&nbsp;false)&nbsp;if&nbsp;(word_width_bytes(size)&nbsp;&lt;&nbsp;sizeof(xlen_bytes))&nbsp;|&nbsp;(not_bool(is_unsigned)&nbsp;&&nbsp;word_width_bytes(size)&nbsp;&lt;=&nbsp;sizeof(xlen_bytes))<br>
&nbsp;&nbsp;&lt;-&gt;&nbsp;imm&nbsp;@&nbsp;rs1&nbsp;@&nbsp;bool_bits(is_unsigned)&nbsp;@&nbsp;size_bits(size)&nbsp;@&nbsp;rd&nbsp;@&nbsp;0b0000011&nbsp;if&nbsp;(word_width_bytes(size)&nbsp;&lt;&nbsp;sizeof(xlen_bytes))&nbsp;|&nbsp;(not_bool(is_unsigned)&nbsp;&&nbsp;word_width_bytes(size)&nbsp;&lt;=&nbsp;sizeof(xlen_bytes))<br>
<br>
val&nbsp;extend_value&nbsp;:&nbsp;forall&nbsp;'n,&nbsp;0&nbsp;&lt;&nbsp;'n&nbsp;&lt;=&nbsp;xlen_bytes.&nbsp;(bool,&nbsp;MemoryOpResult(bits(8&nbsp;*&nbsp;'n)))&nbsp;-&gt;&nbsp;MemoryOpResult(xlenbits)<br>
function&nbsp;extend_value(is_unsigned,&nbsp;value)&nbsp;=&nbsp;<span style="background-color: hsl(220, 85%, 80%)">match&nbsp;(value)&nbsp;{<br>
&nbsp;&nbsp;MemValue(v)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 75%)">MemValue(if&nbsp;is_unsigned&nbsp;then&nbsp;<span style="background-color: hsl(220, 85%, 70%)">EXTZ(v)</span>&nbsp;else&nbsp;<span style="background-color: hsl(220, 85%, 70%)">EXTS(v)&nbsp;:&nbsp;xlenbits</span>)</span>,<br>
&nbsp;&nbsp;MemException(e)&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 75%)">MemException(e)</span><br>
}</span><br>
<br>
val&nbsp;process_load&nbsp;:&nbsp;forall&nbsp;'n,&nbsp;0&nbsp;&lt;&nbsp;'n&nbsp;&lt;=&nbsp;xlen_bytes.&nbsp;(regidx,&nbsp;xlenbits,&nbsp;MemoryOpResult(bits(8&nbsp;*&nbsp;'n)),&nbsp;bool)&nbsp;-&gt;&nbsp;Retired&nbsp;effect&nbsp;{escape,&nbsp;rreg,&nbsp;wreg}<br>
function&nbsp;process_load(rd,&nbsp;addr,&nbsp;value,&nbsp;is_unsigned)&nbsp;=<br>
&nbsp;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">match&nbsp;extend_value(is_unsigned,&nbsp;value)&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;MemValue(result)&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 75%)">{&nbsp;X(rd)&nbsp;=&nbsp;result;&nbsp;RETIRE_SUCCESS&nbsp;}</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;MemException(e)&nbsp;&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 75%)">{&nbsp;handle_mem_exception(addr,&nbsp;e);&nbsp;RETIRE_FAIL&nbsp;}</span><br>
&nbsp;&nbsp;}</span><br>
<br>
function&nbsp;check_misaligned(vaddr&nbsp;:&nbsp;xlenbits,&nbsp;width&nbsp;:&nbsp;word_width)&nbsp;-&gt;&nbsp;bool&nbsp;=<br>
&nbsp;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">if&nbsp;&nbsp;&nbsp;plat_enable_misaligned_access()&nbsp;then&nbsp;<span style="background-color: hsl(50, 85%, 80%)">false</span><br>
&nbsp;&nbsp;else&nbsp;<span style="background-color: hsl(220, 85%, 75%)">match&nbsp;width&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BYTE&nbsp;&nbsp;&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 70%)">false</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HALF&nbsp;&nbsp;&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 70%)">vaddr[0]&nbsp;==&nbsp;bitone</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WORD&nbsp;&nbsp;&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 70%)">vaddr[0]&nbsp;==&nbsp;bitone&nbsp;|&nbsp;vaddr[1]&nbsp;==&nbsp;bitone</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DOUBLE&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 70%)">vaddr[0]&nbsp;==&nbsp;bitone&nbsp;|&nbsp;vaddr[1]&nbsp;==&nbsp;bitone&nbsp;|&nbsp;vaddr[2]&nbsp;==&nbsp;bitone</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span><br>
<br>
function&nbsp;clause&nbsp;execute(LOAD(imm,&nbsp;rs1,&nbsp;rd,&nbsp;is_unsigned,&nbsp;width,&nbsp;aq,&nbsp;rl))&nbsp;=&nbsp;<span style="background-color: hsl(220, 85%, 80%)">{<br>
&nbsp;&nbsp;let&nbsp;offset&nbsp;:&nbsp;xlenbits&nbsp;=&nbsp;EXTS(imm);<br>
&nbsp;&nbsp;/*&nbsp;Get&nbsp;the&nbsp;address,&nbsp;X(rs1)&nbsp;+&nbsp;offset.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Some&nbsp;extensions&nbsp;perform&nbsp;additional&nbsp;checks&nbsp;on&nbsp;address&nbsp;validity.&nbsp;*/<br>
&nbsp;&nbsp;match&nbsp;ext_data_get_addr(rs1,&nbsp;offset,&nbsp;Read(Data),&nbsp;width)&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;Ext_DataAddr_Error(e)&nbsp;&nbsp;=&gt;&nbsp;<span style="background-color: hsl(50, 85%, 80%)">{&nbsp;ext_handle_data_check_error(e);&nbsp;RETIRE_FAIL&nbsp;}</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;Ext_DataAddr_OK(vaddr)&nbsp;=&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="background-color: hsl(220, 85%, 75%)">if&nbsp;&nbsp;&nbsp;check_misaligned(vaddr,&nbsp;width)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;<span style="background-color: hsl(220, 85%, 70%)">{&nbsp;handle_mem_exception(vaddr,&nbsp;E_Load_Addr_Align());&nbsp;RETIRE_FAIL&nbsp;}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;<span style="background-color: hsl(220, 85%, 70%)">match&nbsp;translateAddr(vaddr,&nbsp;Read(Data))&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TR_Failure(e,&nbsp;_)&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 65%)">{&nbsp;handle_mem_exception(vaddr,&nbsp;e);&nbsp;RETIRE_FAIL&nbsp;}</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TR_Address(addr,&nbsp;_)&nbsp;=&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="background-color: hsl(220, 85%, 65%)">match&nbsp;(width,&nbsp;sizeof(xlen))&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(BYTE,&nbsp;_)&nbsp;&nbsp;&nbsp;=&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="background-color: hsl(220, 85%, 60%)">process_load(rd,&nbsp;vaddr,&nbsp;mem_read(Read(Data),&nbsp;addr,&nbsp;1,&nbsp;aq,&nbsp;rl,&nbsp;false),&nbsp;is_unsigned)</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(HALF,&nbsp;_)&nbsp;&nbsp;&nbsp;=&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="background-color: hsl(220, 85%, 60%)">process_load(rd,&nbsp;vaddr,&nbsp;mem_read(Read(Data),&nbsp;addr,&nbsp;2,&nbsp;aq,&nbsp;rl,&nbsp;false),&nbsp;is_unsigned)</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(WORD,&nbsp;_)&nbsp;&nbsp;&nbsp;=&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="background-color: hsl(220, 85%, 60%)">process_load(rd,&nbsp;vaddr,&nbsp;mem_read(Read(Data),&nbsp;addr,&nbsp;4,&nbsp;aq,&nbsp;rl,&nbsp;false),&nbsp;is_unsigned)</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(DOUBLE,&nbsp;64)&nbsp;=&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="background-color: hsl(220, 85%, 60%)">process_load(rd,&nbsp;vaddr,&nbsp;mem_read(Read(Data),&nbsp;addr,&nbsp;8,&nbsp;aq,&nbsp;rl,&nbsp;false),&nbsp;is_unsigned)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span><br>
&nbsp;&nbsp;}<br>
}</span><br>
<br>
val&nbsp;maybe_aq&nbsp;:&nbsp;bool&nbsp;&lt;-&gt;&nbsp;string<br>
mapping&nbsp;maybe_aq&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;true&nbsp;&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(50, 85%, 80%)">&quot;.aq&quot;</span>,<br>
&nbsp;&nbsp;false&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">&quot;&quot;</span><br>
}<br>
<br>
val&nbsp;maybe_rl&nbsp;:&nbsp;bool&nbsp;&lt;-&gt;&nbsp;string<br>
mapping&nbsp;maybe_rl&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;true&nbsp;&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(50, 85%, 80%)">&quot;.rl&quot;</span>,<br>
&nbsp;&nbsp;false&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">&quot;&quot;</span><br>
}<br>
<br>
val&nbsp;maybe_u&nbsp;:&nbsp;bool&nbsp;&lt;-&gt;&nbsp;string<br>
mapping&nbsp;maybe_u&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;true&nbsp;&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">&quot;u&quot;</span>,<br>
&nbsp;&nbsp;false&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">&quot;&quot;</span><br>
}<br>
<br>
mapping&nbsp;clause&nbsp;assembly&nbsp;=&nbsp;LOAD(imm,&nbsp;rs1,&nbsp;rd,&nbsp;is_unsigned,&nbsp;size,&nbsp;aq,&nbsp;rl)<br>
&nbsp;&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">&quot;l&quot;&nbsp;^&nbsp;size_mnemonic(size)&nbsp;^&nbsp;maybe_u(is_unsigned)&nbsp;^&nbsp;maybe_aq(aq)&nbsp;^&nbsp;maybe_rl(rl)&nbsp;^&nbsp;spc()&nbsp;^&nbsp;reg_name(rd)&nbsp;^&nbsp;sep()&nbsp;^&nbsp;hex_bits_12(imm)&nbsp;^&nbsp;opt_spc()&nbsp;^&nbsp;&quot;(&quot;&nbsp;^&nbsp;opt_spc()&nbsp;^&nbsp;reg_name(rs1)&nbsp;^&nbsp;opt_spc()&nbsp;^&nbsp;&quot;)&quot;</span><br>
<br>
/*&nbsp;******************************************************************&nbsp;*/<br>
union&nbsp;clause&nbsp;ast&nbsp;=&nbsp;STORE&nbsp;:&nbsp;(bits(12),&nbsp;regidx,&nbsp;regidx,&nbsp;word_width,&nbsp;bool,&nbsp;bool)<br>
<br>
mapping&nbsp;clause&nbsp;encdec&nbsp;=&nbsp;STORE(imm7&nbsp;@&nbsp;imm5,&nbsp;rs2,&nbsp;rs1,&nbsp;size,&nbsp;false,&nbsp;false)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;word_width_bytes(size)&nbsp;&lt;=&nbsp;sizeof(xlen_bytes)<br>
&nbsp;&nbsp;&lt;-&gt;&nbsp;imm7&nbsp;:&nbsp;bits(7)&nbsp;@&nbsp;rs2&nbsp;@&nbsp;rs1&nbsp;@&nbsp;0b0&nbsp;@&nbsp;size_bits(size)&nbsp;@&nbsp;imm5&nbsp;:&nbsp;bits(5)&nbsp;@&nbsp;0b0100011&nbsp;if&nbsp;word_width_bytes(size)&nbsp;&lt;=&nbsp;sizeof(xlen_bytes)<br>
<br>
/*&nbsp;NOTE:&nbsp;Currently,&nbsp;we&nbsp;only&nbsp;EA&nbsp;if&nbsp;address&nbsp;translation&nbsp;is&nbsp;successful.<br>
&nbsp;&nbsp;&nbsp;This&nbsp;may&nbsp;need&nbsp;revisiting.&nbsp;*/<br>
function&nbsp;clause&nbsp;execute&nbsp;(STORE(imm,&nbsp;rs2,&nbsp;rs1,&nbsp;width,&nbsp;aq,&nbsp;rl))&nbsp;=&nbsp;<span style="background-color: hsl(220, 85%, 80%)">{<br>
&nbsp;&nbsp;let&nbsp;offset&nbsp;:&nbsp;xlenbits&nbsp;=&nbsp;EXTS(imm);<br>
&nbsp;&nbsp;/*&nbsp;Get&nbsp;the&nbsp;address,&nbsp;X(rs1)&nbsp;+&nbsp;offset.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Some&nbsp;extensions&nbsp;perform&nbsp;additional&nbsp;checks&nbsp;on&nbsp;address&nbsp;validity.&nbsp;*/<br>
&nbsp;&nbsp;match&nbsp;ext_data_get_addr(rs1,&nbsp;offset,&nbsp;Write(Data),&nbsp;width)&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;Ext_DataAddr_Error(e)&nbsp;&nbsp;=&gt;&nbsp;<span style="background-color: hsl(50, 85%, 80%)">{&nbsp;ext_handle_data_check_error(e);&nbsp;RETIRE_FAIL&nbsp;}</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;Ext_DataAddr_OK(vaddr)&nbsp;=&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="background-color: hsl(220, 85%, 75%)">if&nbsp;&nbsp;&nbsp;check_misaligned(vaddr,&nbsp;width)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;<span style="background-color: hsl(220, 85%, 70%)">{&nbsp;handle_mem_exception(vaddr,&nbsp;E_SAMO_Addr_Align());&nbsp;RETIRE_FAIL&nbsp;}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;<span style="background-color: hsl(220, 85%, 70%)">match&nbsp;translateAddr(vaddr,&nbsp;Write(Data))&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TR_Failure(e,&nbsp;_)&nbsp;&nbsp;&nbsp;&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 65%)">{&nbsp;handle_mem_exception(vaddr,&nbsp;e);&nbsp;RETIRE_FAIL&nbsp;}</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TR_Address(addr,&nbsp;_)&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 65%)">{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;let&nbsp;eares&nbsp;:&nbsp;MemoryOpResult(unit)&nbsp;=&nbsp;match&nbsp;width&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BYTE&nbsp;&nbsp;&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 60%)">mem_write_ea(addr,&nbsp;1,&nbsp;aq,&nbsp;rl,&nbsp;false)</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HALF&nbsp;&nbsp;&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 60%)">mem_write_ea(addr,&nbsp;2,&nbsp;aq,&nbsp;rl,&nbsp;false)</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WORD&nbsp;&nbsp;&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 60%)">mem_write_ea(addr,&nbsp;4,&nbsp;aq,&nbsp;rl,&nbsp;false)</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DOUBLE&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 60%)">mem_write_ea(addr,&nbsp;8,&nbsp;aq,&nbsp;rl,&nbsp;false)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;match&nbsp;(eares)&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MemException(e)&nbsp;=&gt;&nbsp;<span style="background-color: hsl(50, 85%, 80%)">{&nbsp;handle_mem_exception(addr,&nbsp;e);&nbsp;RETIRE_FAIL&nbsp;}</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MemValue(_)&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 60%)">{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;let&nbsp;rs2_val&nbsp;=&nbsp;X(rs2);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;let&nbsp;res&nbsp;:&nbsp;MemoryOpResult(bool)&nbsp;=&nbsp;match&nbsp;(width,&nbsp;sizeof(xlen))&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(BYTE,&nbsp;_)&nbsp;&nbsp;&nbsp;&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 55%)">mem_write_value(addr,&nbsp;1,&nbsp;rs2_val[7..0],&nbsp;&nbsp;aq,&nbsp;rl,&nbsp;false)</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(HALF,&nbsp;_)&nbsp;&nbsp;&nbsp;&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 55%)">mem_write_value(addr,&nbsp;2,&nbsp;rs2_val[15..0],&nbsp;aq,&nbsp;rl,&nbsp;false)</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(WORD,&nbsp;_)&nbsp;&nbsp;&nbsp;&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 55%)">mem_write_value(addr,&nbsp;4,&nbsp;rs2_val[31..0],&nbsp;aq,&nbsp;rl,&nbsp;false)</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(DOUBLE,&nbsp;64)&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 55%)">mem_write_value(addr,&nbsp;8,&nbsp;rs2_val,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;aq,&nbsp;rl,&nbsp;false)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;match&nbsp;(res)&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MemValue(true)&nbsp;&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 55%)">RETIRE_SUCCESS</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MemValue(false)&nbsp;=&gt;&nbsp;<span style="background-color: hsl(50, 85%, 80%)">internal_error(&quot;store&nbsp;got&nbsp;false&nbsp;from&nbsp;mem_write_value&quot;)</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MemException(e)&nbsp;=&gt;&nbsp;<span style="background-color: hsl(50, 85%, 80%)">{&nbsp;handle_mem_exception(addr,&nbsp;e);&nbsp;RETIRE_FAIL&nbsp;}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span><br>
&nbsp;&nbsp;}<br>
}</span><br>
<br>
mapping&nbsp;clause&nbsp;assembly&nbsp;=&nbsp;STORE(imm,&nbsp;rs2,&nbsp;rs1,&nbsp;size,&nbsp;aq,&nbsp;rl)<br>
&nbsp;&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">&quot;s&quot;&nbsp;^&nbsp;size_mnemonic(size)&nbsp;^&nbsp;maybe_aq(aq)&nbsp;^&nbsp;maybe_rl(rl)&nbsp;^&nbsp;spc()&nbsp;^&nbsp;reg_name(rs2)&nbsp;^&nbsp;sep()&nbsp;^&nbsp;hex_bits_12(imm)&nbsp;^&nbsp;opt_spc()&nbsp;^&nbsp;&quot;(&quot;&nbsp;^&nbsp;opt_spc()&nbsp;^&nbsp;reg_name(rs1)&nbsp;^&nbsp;opt_spc()&nbsp;^&nbsp;&quot;)&quot;</span><br>
<br>
/*&nbsp;******************************************************************&nbsp;*/<br>
union&nbsp;clause&nbsp;ast&nbsp;=&nbsp;ADDIW&nbsp;:&nbsp;(bits(12),&nbsp;regidx,&nbsp;regidx)<br>
<br>
mapping&nbsp;clause&nbsp;encdec&nbsp;=&nbsp;<span style="background-color: hsl(220, 85%, 80%)">ADDIW(imm,&nbsp;rs1,&nbsp;rd)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;sizeof(xlen)&nbsp;==&nbsp;64<br>
&nbsp;&nbsp;&lt;-&gt;&nbsp;imm&nbsp;@&nbsp;rs1&nbsp;@&nbsp;0b000&nbsp;@&nbsp;rd&nbsp;@&nbsp;0b0011011<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;sizeof(xlen)&nbsp;==&nbsp;64<br>
<br>
function&nbsp;clause&nbsp;execute&nbsp;(ADDIW(imm,&nbsp;rs1,&nbsp;rd))&nbsp;=&nbsp;<span style="background-color: hsl(220, 85%, 80%)">{<br>
&nbsp;&nbsp;let&nbsp;result&nbsp;:&nbsp;xlenbits&nbsp;=&nbsp;EXTS(imm)&nbsp;+&nbsp;X(rs1);<br>
&nbsp;&nbsp;X(rd)&nbsp;=&nbsp;EXTS(result[31..0]);<br>
&nbsp;&nbsp;RETIRE_SUCCESS<br>
}</span><br>
<br>
mapping&nbsp;clause&nbsp;assembly&nbsp;=&nbsp;ADDIW(imm,&nbsp;rs1,&nbsp;rd)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;sizeof(xlen)&nbsp;==&nbsp;64<br>
&nbsp;&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">&quot;addiw&quot;&nbsp;^&nbsp;spc()&nbsp;^&nbsp;reg_name(rd)&nbsp;^&nbsp;sep()&nbsp;^&nbsp;reg_name(rs1)&nbsp;^&nbsp;sep()&nbsp;^&nbsp;hex_bits_12(imm)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;sizeof(xlen)&nbsp;==&nbsp;64<br>
<br>
/*&nbsp;******************************************************************&nbsp;*/<br>
union&nbsp;clause&nbsp;ast&nbsp;=&nbsp;SHIFTW&nbsp;:&nbsp;(bits(5),&nbsp;regidx,&nbsp;regidx,&nbsp;sop)<br>
<br>
mapping&nbsp;clause&nbsp;encdec&nbsp;=&nbsp;<span style="background-color: hsl(220, 85%, 80%)">SHIFTW(shamt,&nbsp;rs1,&nbsp;rd,&nbsp;RISCV_SLLI)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;sizeof(xlen)&nbsp;==&nbsp;64<br>
&nbsp;&nbsp;&lt;-&gt;&nbsp;0b0000000&nbsp;@&nbsp;shamt&nbsp;@&nbsp;rs1&nbsp;@&nbsp;0b001&nbsp;@&nbsp;rd&nbsp;@&nbsp;0b0011011<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;sizeof(xlen)&nbsp;==&nbsp;64<br>
mapping&nbsp;clause&nbsp;encdec&nbsp;=&nbsp;<span style="background-color: hsl(220, 85%, 80%)">SHIFTW(shamt,&nbsp;rs1,&nbsp;rd,&nbsp;RISCV_SRLI)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;sizeof(xlen)&nbsp;==&nbsp;64<br>
&nbsp;&nbsp;&lt;-&gt;&nbsp;0b0000000&nbsp;@&nbsp;shamt&nbsp;@&nbsp;rs1&nbsp;@&nbsp;0b101&nbsp;@&nbsp;rd&nbsp;@&nbsp;0b0011011<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;sizeof(xlen)&nbsp;==&nbsp;64<br>
mapping&nbsp;clause&nbsp;encdec&nbsp;=&nbsp;<span style="background-color: hsl(220, 85%, 80%)">SHIFTW(shamt,&nbsp;rs1,&nbsp;rd,&nbsp;RISCV_SRAI)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;sizeof(xlen)&nbsp;==&nbsp;64<br>
&nbsp;&nbsp;&lt;-&gt;&nbsp;0b0100000&nbsp;@&nbsp;shamt&nbsp;@&nbsp;rs1&nbsp;@&nbsp;0b101&nbsp;@&nbsp;rd&nbsp;@&nbsp;0b0011011<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;sizeof(xlen)&nbsp;==&nbsp;64<br>
<br>
function&nbsp;clause&nbsp;execute&nbsp;(SHIFTW(shamt,&nbsp;rs1,&nbsp;rd,&nbsp;op))&nbsp;=&nbsp;<span style="background-color: hsl(220, 85%, 80%)">{<br>
&nbsp;&nbsp;let&nbsp;rs1_val&nbsp;=&nbsp;(X(rs1))[31..0];<br>
&nbsp;&nbsp;let&nbsp;result&nbsp;:&nbsp;bits(32)&nbsp;=&nbsp;match&nbsp;op&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;RISCV_SLLI&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 75%)">rs1_val&nbsp;&lt;&lt;&nbsp;shamt</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;RISCV_SRLI&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 75%)">rs1_val&nbsp;&gt;&gt;&nbsp;shamt</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;RISCV_SRAI&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 75%)">shift_right_arith32(rs1_val,&nbsp;shamt)</span><br>
&nbsp;&nbsp;};<br>
&nbsp;&nbsp;X(rd)&nbsp;=&nbsp;EXTS(result);<br>
&nbsp;&nbsp;RETIRE_SUCCESS<br>
}</span><br>
<br>
mapping&nbsp;shiftw_mnemonic&nbsp;:&nbsp;sop&nbsp;&lt;-&gt;&nbsp;string&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;RISCV_SLLI&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">&quot;slli&quot;</span>,<br>
&nbsp;&nbsp;RISCV_SRLI&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">&quot;srli&quot;</span>,<br>
&nbsp;&nbsp;RISCV_SRAI&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">&quot;srai&quot;</span><br>
}<br>
<br>
mapping&nbsp;clause&nbsp;assembly&nbsp;=&nbsp;SHIFTW(shamt,&nbsp;rs1,&nbsp;rd,&nbsp;op)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;sizeof(xlen)&nbsp;==&nbsp;64<br>
&nbsp;&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">shiftw_mnemonic(op)&nbsp;^&nbsp;spc()&nbsp;^&nbsp;reg_name(rd)&nbsp;^&nbsp;sep()&nbsp;^&nbsp;reg_name(rs1)&nbsp;^&nbsp;sep()&nbsp;^&nbsp;hex_bits_5(shamt)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;sizeof(xlen)&nbsp;==&nbsp;64<br>
<br>
/*&nbsp;******************************************************************&nbsp;*/<br>
union&nbsp;clause&nbsp;ast&nbsp;=&nbsp;RTYPEW&nbsp;:&nbsp;(regidx,&nbsp;regidx,&nbsp;regidx,&nbsp;ropw)<br>
<br>
mapping&nbsp;clause&nbsp;encdec&nbsp;=&nbsp;<span style="background-color: hsl(220, 85%, 80%)">RTYPEW(rs2,&nbsp;rs1,&nbsp;rd,&nbsp;RISCV_ADDW)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;sizeof(xlen)&nbsp;==&nbsp;64<br>
&nbsp;&nbsp;&lt;-&gt;&nbsp;0b0000000&nbsp;@&nbsp;rs2&nbsp;@&nbsp;rs1&nbsp;@&nbsp;0b000&nbsp;@&nbsp;rd&nbsp;@&nbsp;0b0111011<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;sizeof(xlen)&nbsp;==&nbsp;64<br>
mapping&nbsp;clause&nbsp;encdec&nbsp;=&nbsp;<span style="background-color: hsl(220, 85%, 80%)">RTYPEW(rs2,&nbsp;rs1,&nbsp;rd,&nbsp;RISCV_SUBW)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;sizeof(xlen)&nbsp;==&nbsp;64<br>
&nbsp;&nbsp;&lt;-&gt;&nbsp;0b0100000&nbsp;@&nbsp;rs2&nbsp;@&nbsp;rs1&nbsp;@&nbsp;0b000&nbsp;@&nbsp;rd&nbsp;@&nbsp;0b0111011<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;sizeof(xlen)&nbsp;==&nbsp;64<br>
mapping&nbsp;clause&nbsp;encdec&nbsp;=&nbsp;<span style="background-color: hsl(220, 85%, 80%)">RTYPEW(rs2,&nbsp;rs1,&nbsp;rd,&nbsp;RISCV_SLLW)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;sizeof(xlen)&nbsp;==&nbsp;64<br>
&nbsp;&nbsp;&lt;-&gt;&nbsp;0b0000000&nbsp;@&nbsp;rs2&nbsp;@&nbsp;rs1&nbsp;@&nbsp;0b001&nbsp;@&nbsp;rd&nbsp;@&nbsp;0b0111011<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;sizeof(xlen)&nbsp;==&nbsp;64<br>
mapping&nbsp;clause&nbsp;encdec&nbsp;=&nbsp;<span style="background-color: hsl(220, 85%, 80%)">RTYPEW(rs2,&nbsp;rs1,&nbsp;rd,&nbsp;RISCV_SRLW)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;sizeof(xlen)&nbsp;==&nbsp;64<br>
&nbsp;&nbsp;&lt;-&gt;&nbsp;0b0000000&nbsp;@&nbsp;rs2&nbsp;@&nbsp;rs1&nbsp;@&nbsp;0b101&nbsp;@&nbsp;rd&nbsp;@&nbsp;0b0111011<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;sizeof(xlen)&nbsp;==&nbsp;64<br>
mapping&nbsp;clause&nbsp;encdec&nbsp;=&nbsp;<span style="background-color: hsl(220, 85%, 80%)">RTYPEW(rs2,&nbsp;rs1,&nbsp;rd,&nbsp;RISCV_SRAW)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;sizeof(xlen)&nbsp;==&nbsp;64<br>
&nbsp;&nbsp;&lt;-&gt;&nbsp;0b0100000&nbsp;@&nbsp;rs2&nbsp;@&nbsp;rs1&nbsp;@&nbsp;0b101&nbsp;@&nbsp;rd&nbsp;@&nbsp;0b0111011<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;sizeof(xlen)&nbsp;==&nbsp;64<br>
<br>
function&nbsp;clause&nbsp;execute&nbsp;(RTYPEW(rs2,&nbsp;rs1,&nbsp;rd,&nbsp;op))&nbsp;=&nbsp;<span style="background-color: hsl(220, 85%, 80%)">{<br>
&nbsp;&nbsp;let&nbsp;rs1_val&nbsp;=&nbsp;(X(rs1))[31..0];<br>
&nbsp;&nbsp;let&nbsp;rs2_val&nbsp;=&nbsp;(X(rs2))[31..0];<br>
&nbsp;&nbsp;let&nbsp;result&nbsp;:&nbsp;bits(32)&nbsp;=&nbsp;match&nbsp;op&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;RISCV_ADDW&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 75%)">rs1_val&nbsp;+&nbsp;rs2_val</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;RISCV_SUBW&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 75%)">rs1_val&nbsp;-&nbsp;rs2_val</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;RISCV_SLLW&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 75%)">rs1_val&nbsp;&lt;&lt;&nbsp;(rs2_val[4..0])</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;RISCV_SRLW&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 75%)">rs1_val&nbsp;&gt;&gt;&nbsp;(rs2_val[4..0])</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;RISCV_SRAW&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 75%)">shift_right_arith32(rs1_val,&nbsp;rs2_val[4..0])</span><br>
&nbsp;&nbsp;};<br>
&nbsp;&nbsp;X(rd)&nbsp;=&nbsp;EXTS(result);<br>
&nbsp;&nbsp;RETIRE_SUCCESS<br>
}</span><br>
<br>
mapping&nbsp;rtypew_mnemonic&nbsp;:&nbsp;ropw&nbsp;&lt;-&gt;&nbsp;string&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;RISCV_ADDW&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">&quot;addw&quot;</span>,<br>
&nbsp;&nbsp;RISCV_SUBW&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">&quot;subw&quot;</span>,<br>
&nbsp;&nbsp;RISCV_SLLW&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">&quot;sllw&quot;</span>,<br>
&nbsp;&nbsp;RISCV_SRLW&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">&quot;srlw&quot;</span>,<br>
&nbsp;&nbsp;RISCV_SRAW&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">&quot;sraw&quot;</span><br>
}<br>
<br>
mapping&nbsp;clause&nbsp;assembly&nbsp;=&nbsp;RTYPEW(rs2,&nbsp;rs1,&nbsp;rd,&nbsp;op)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;sizeof(xlen)&nbsp;==&nbsp;64<br>
&nbsp;&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">rtypew_mnemonic(op)&nbsp;^&nbsp;spc()&nbsp;^&nbsp;reg_name(rd)&nbsp;^&nbsp;sep()&nbsp;^&nbsp;reg_name(rs1)&nbsp;^&nbsp;sep()&nbsp;^&nbsp;reg_name(rs2)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;sizeof(xlen)&nbsp;==&nbsp;64<br>
<br>
/*&nbsp;******************************************************************&nbsp;*/<br>
union&nbsp;clause&nbsp;ast&nbsp;=&nbsp;SHIFTIWOP&nbsp;:&nbsp;(bits(5),&nbsp;regidx,&nbsp;regidx,&nbsp;sopw)<br>
<br>
mapping&nbsp;clause&nbsp;encdec&nbsp;=&nbsp;<span style="background-color: hsl(50, 85%, 80%)">SHIFTIWOP(shamt,&nbsp;rs1,&nbsp;rd,&nbsp;RISCV_SLLIW)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;sizeof(xlen)&nbsp;==&nbsp;64<br>
&nbsp;&nbsp;&lt;-&gt;&nbsp;0b0000000&nbsp;@&nbsp;shamt&nbsp;@&nbsp;rs1&nbsp;@&nbsp;0b001&nbsp;@&nbsp;rd&nbsp;@&nbsp;0b0011011<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;sizeof(xlen)&nbsp;==&nbsp;64<br>
mapping&nbsp;clause&nbsp;encdec&nbsp;=&nbsp;<span style="background-color: hsl(50, 85%, 80%)">SHIFTIWOP(shamt,&nbsp;rs1,&nbsp;rd,&nbsp;RISCV_SRLIW)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;sizeof(xlen)&nbsp;==&nbsp;64<br>
&nbsp;&nbsp;&lt;-&gt;&nbsp;0b0000000&nbsp;@&nbsp;shamt&nbsp;@&nbsp;rs1&nbsp;@&nbsp;0b101&nbsp;@&nbsp;rd&nbsp;@&nbsp;0b0011011<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;sizeof(xlen)&nbsp;==&nbsp;64<br>
mapping&nbsp;clause&nbsp;encdec&nbsp;=&nbsp;<span style="background-color: hsl(50, 85%, 80%)">SHIFTIWOP(shamt,&nbsp;rs1,&nbsp;rd,&nbsp;RISCV_SRAIW)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;sizeof(xlen)&nbsp;==&nbsp;64<br>
&nbsp;&nbsp;&lt;-&gt;&nbsp;0b0100000&nbsp;@&nbsp;shamt&nbsp;@&nbsp;rs1&nbsp;@&nbsp;0b101&nbsp;@&nbsp;rd&nbsp;@&nbsp;0b0011011<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;sizeof(xlen)&nbsp;==&nbsp;64<br>
<br>
function&nbsp;clause&nbsp;execute&nbsp;(SHIFTIWOP(shamt,&nbsp;rs1,&nbsp;rd,&nbsp;op))&nbsp;=&nbsp;<span style="background-color: hsl(50, 85%, 80%)">{<br>
&nbsp;&nbsp;let&nbsp;rs1_val&nbsp;=&nbsp;X(rs1);<br>
&nbsp;&nbsp;let&nbsp;result&nbsp;:&nbsp;bits(32)&nbsp;=&nbsp;match&nbsp;op&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;RISCV_SLLIW&nbsp;=&gt;&nbsp;<span style="background-color: hsl(50, 85%, 75%)">rs1_val[31..0]&nbsp;&lt;&lt;&nbsp;shamt</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;RISCV_SRLIW&nbsp;=&gt;&nbsp;<span style="background-color: hsl(50, 85%, 75%)">rs1_val[31..0]&nbsp;&gt;&gt;&nbsp;shamt</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;RISCV_SRAIW&nbsp;=&gt;&nbsp;<span style="background-color: hsl(50, 85%, 75%)">shift_right_arith32(rs1_val[31..0],&nbsp;shamt)</span><br>
&nbsp;&nbsp;};<br>
&nbsp;&nbsp;X(rd)&nbsp;=&nbsp;EXTS(result);<br>
&nbsp;&nbsp;RETIRE_SUCCESS<br>
}</span><br>
<br>
mapping&nbsp;shiftiwop_mnemonic&nbsp;:&nbsp;sopw&nbsp;&lt;-&gt;&nbsp;string&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;RISCV_SLLIW&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(50, 85%, 80%)">&quot;slliw&quot;</span>,<br>
&nbsp;&nbsp;RISCV_SRLIW&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(50, 85%, 80%)">&quot;srliw&quot;</span>,<br>
&nbsp;&nbsp;RISCV_SRAIW&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(50, 85%, 80%)">&quot;sraiw&quot;</span><br>
}<br>
<br>
mapping&nbsp;clause&nbsp;assembly&nbsp;=&nbsp;SHIFTIWOP(shamt,&nbsp;rs1,&nbsp;rd,&nbsp;op)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;sizeof(xlen)&nbsp;==&nbsp;64<br>
&nbsp;&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(50, 85%, 80%)">shiftiwop_mnemonic(op)&nbsp;^&nbsp;spc()&nbsp;^&nbsp;reg_name(rd)&nbsp;^&nbsp;sep()&nbsp;^&nbsp;reg_name(rs1)&nbsp;^&nbsp;sep()&nbsp;^&nbsp;hex_bits_5(shamt)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;sizeof(xlen)&nbsp;==&nbsp;64<br>
<br>
/*&nbsp;******************************************************************&nbsp;*/<br>
union&nbsp;clause&nbsp;ast&nbsp;=&nbsp;FENCE&nbsp;:&nbsp;(bits(4),&nbsp;bits(4))<br>
<br>
mapping&nbsp;clause&nbsp;encdec&nbsp;=&nbsp;<span style="background-color: hsl(220, 85%, 80%)">FENCE(pred,&nbsp;succ)</span><br>
&nbsp;&nbsp;&lt;-&gt;&nbsp;0b0000&nbsp;@&nbsp;pred&nbsp;@&nbsp;succ&nbsp;@&nbsp;0b00000&nbsp;@&nbsp;0b000&nbsp;@&nbsp;0b00000&nbsp;@&nbsp;0b0001111<br>
<br>
/*&nbsp;For&nbsp;future&nbsp;versions&nbsp;of&nbsp;Sail&nbsp;where&nbsp;barriers&nbsp;can&nbsp;be&nbsp;parameterised&nbsp;*/<br>
$ifdef&nbsp;FEATURE_UNION_BARRIER<br>
<br>
function&nbsp;clause&nbsp;execute&nbsp;(FENCE(pred,&nbsp;succ))&nbsp;=&nbsp;<span style="background-color: hsl(220, 85%, 80%)">{<br>
&nbsp;&nbsp;match&nbsp;(pred,&nbsp;succ)&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;(_&nbsp;:&nbsp;bits(2)&nbsp;@&nbsp;0b11,&nbsp;_&nbsp;:&nbsp;bits(2)&nbsp;@&nbsp;0b11)&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 75%)">__barrier(Barrier_RISCV_rw_rw())</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;(_&nbsp;:&nbsp;bits(2)&nbsp;@&nbsp;0b10,&nbsp;_&nbsp;:&nbsp;bits(2)&nbsp;@&nbsp;0b11)&nbsp;=&gt;&nbsp;<span style="background-color: hsl(50, 85%, 80%)">__barrier(Barrier_RISCV_r_rw())</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;(_&nbsp;:&nbsp;bits(2)&nbsp;@&nbsp;0b10,&nbsp;_&nbsp;:&nbsp;bits(2)&nbsp;@&nbsp;0b10)&nbsp;=&gt;&nbsp;<span style="background-color: hsl(50, 85%, 80%)">__barrier(Barrier_RISCV_r_r())</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;(_&nbsp;:&nbsp;bits(2)&nbsp;@&nbsp;0b11,&nbsp;_&nbsp;:&nbsp;bits(2)&nbsp;@&nbsp;0b01)&nbsp;=&gt;&nbsp;<span style="background-color: hsl(50, 85%, 80%)">__barrier(Barrier_RISCV_rw_w())</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;(_&nbsp;:&nbsp;bits(2)&nbsp;@&nbsp;0b01,&nbsp;_&nbsp;:&nbsp;bits(2)&nbsp;@&nbsp;0b01)&nbsp;=&gt;&nbsp;<span style="background-color: hsl(50, 85%, 80%)">__barrier(Barrier_RISCV_w_w())</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;(_&nbsp;:&nbsp;bits(2)&nbsp;@&nbsp;0b01,&nbsp;_&nbsp;:&nbsp;bits(2)&nbsp;@&nbsp;0b11)&nbsp;=&gt;&nbsp;<span style="background-color: hsl(50, 85%, 80%)">__barrier(Barrier_RISCV_w_rw())</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;(_&nbsp;:&nbsp;bits(2)&nbsp;@&nbsp;0b11,&nbsp;_&nbsp;:&nbsp;bits(2)&nbsp;@&nbsp;0b10)&nbsp;=&gt;&nbsp;<span style="background-color: hsl(50, 85%, 80%)">__barrier(Barrier_RISCV_rw_r())</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;(_&nbsp;:&nbsp;bits(2)&nbsp;@&nbsp;0b10,&nbsp;_&nbsp;:&nbsp;bits(2)&nbsp;@&nbsp;0b01)&nbsp;=&gt;&nbsp;<span style="background-color: hsl(50, 85%, 80%)">__barrier(Barrier_RISCV_r_w())</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;(_&nbsp;:&nbsp;bits(2)&nbsp;@&nbsp;0b01,&nbsp;_&nbsp;:&nbsp;bits(2)&nbsp;@&nbsp;0b10)&nbsp;=&gt;&nbsp;<span style="background-color: hsl(50, 85%, 80%)">__barrier(Barrier_RISCV_w_r())</span>,<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;(_&nbsp;:&nbsp;bits(2)&nbsp;@&nbsp;0b00,&nbsp;_&nbsp;:&nbsp;bits(2)&nbsp;@&nbsp;0b00)&nbsp;=&gt;&nbsp;<span style="background-color: hsl(50, 85%, 80%)">()</span>,<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;_&nbsp;=&gt;&nbsp;<span style="background-color: hsl(50, 85%, 80%)">{&nbsp;print(&quot;FIXME:&nbsp;unsupported&nbsp;fence&quot;);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;()&nbsp;}</span><br>
&nbsp;&nbsp;};<br>
&nbsp;&nbsp;RETIRE_SUCCESS<br>
}</span><br>
<br>
$else<br>
<br>
function&nbsp;clause&nbsp;execute&nbsp;(FENCE(pred,&nbsp;succ))&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;match&nbsp;(pred,&nbsp;succ)&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;(_&nbsp;:&nbsp;bits(2)&nbsp;@&nbsp;0b11,&nbsp;_&nbsp;:&nbsp;bits(2)&nbsp;@&nbsp;0b11)&nbsp;=&gt;&nbsp;__barrier(Barrier_RISCV_rw_rw),<br>
&nbsp;&nbsp;&nbsp;&nbsp;(_&nbsp;:&nbsp;bits(2)&nbsp;@&nbsp;0b10,&nbsp;_&nbsp;:&nbsp;bits(2)&nbsp;@&nbsp;0b11)&nbsp;=&gt;&nbsp;__barrier(Barrier_RISCV_r_rw),<br>
&nbsp;&nbsp;&nbsp;&nbsp;(_&nbsp;:&nbsp;bits(2)&nbsp;@&nbsp;0b10,&nbsp;_&nbsp;:&nbsp;bits(2)&nbsp;@&nbsp;0b10)&nbsp;=&gt;&nbsp;__barrier(Barrier_RISCV_r_r),<br>
&nbsp;&nbsp;&nbsp;&nbsp;(_&nbsp;:&nbsp;bits(2)&nbsp;@&nbsp;0b11,&nbsp;_&nbsp;:&nbsp;bits(2)&nbsp;@&nbsp;0b01)&nbsp;=&gt;&nbsp;__barrier(Barrier_RISCV_rw_w),<br>
&nbsp;&nbsp;&nbsp;&nbsp;(_&nbsp;:&nbsp;bits(2)&nbsp;@&nbsp;0b01,&nbsp;_&nbsp;:&nbsp;bits(2)&nbsp;@&nbsp;0b01)&nbsp;=&gt;&nbsp;__barrier(Barrier_RISCV_w_w),<br>
&nbsp;&nbsp;&nbsp;&nbsp;(_&nbsp;:&nbsp;bits(2)&nbsp;@&nbsp;0b01,&nbsp;_&nbsp;:&nbsp;bits(2)&nbsp;@&nbsp;0b11)&nbsp;=&gt;&nbsp;__barrier(Barrier_RISCV_w_rw),<br>
&nbsp;&nbsp;&nbsp;&nbsp;(_&nbsp;:&nbsp;bits(2)&nbsp;@&nbsp;0b11,&nbsp;_&nbsp;:&nbsp;bits(2)&nbsp;@&nbsp;0b10)&nbsp;=&gt;&nbsp;__barrier(Barrier_RISCV_rw_r),<br>
&nbsp;&nbsp;&nbsp;&nbsp;(_&nbsp;:&nbsp;bits(2)&nbsp;@&nbsp;0b10,&nbsp;_&nbsp;:&nbsp;bits(2)&nbsp;@&nbsp;0b01)&nbsp;=&gt;&nbsp;__barrier(Barrier_RISCV_r_w),<br>
&nbsp;&nbsp;&nbsp;&nbsp;(_&nbsp;:&nbsp;bits(2)&nbsp;@&nbsp;0b01,&nbsp;_&nbsp;:&nbsp;bits(2)&nbsp;@&nbsp;0b10)&nbsp;=&gt;&nbsp;__barrier(Barrier_RISCV_w_r),<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;(_&nbsp;:&nbsp;bits(2)&nbsp;@&nbsp;0b00,&nbsp;_&nbsp;:&nbsp;bits(2)&nbsp;@&nbsp;0b00)&nbsp;=&gt;&nbsp;(),<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;_&nbsp;=&gt;&nbsp;{&nbsp;print(&quot;FIXME:&nbsp;unsupported&nbsp;fence&quot;);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;()&nbsp;}<br>
&nbsp;&nbsp;};<br>
&nbsp;&nbsp;RETIRE_SUCCESS<br>
}<br>
<br>
$endif<br>
<br>
mapping&nbsp;bit_maybe_r&nbsp;:&nbsp;bits(1)&nbsp;&lt;-&gt;&nbsp;string&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;0b1&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">&quot;r&quot;</span>,<br>
&nbsp;&nbsp;0b0&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(50, 85%, 80%)">&quot;&quot;</span><br>
}<br>
<br>
mapping&nbsp;bit_maybe_w&nbsp;:&nbsp;bits(1)&nbsp;&lt;-&gt;&nbsp;string&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;0b1&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">&quot;w&quot;</span>,<br>
&nbsp;&nbsp;0b0&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(50, 85%, 80%)">&quot;&quot;</span><br>
}<br>
<br>
mapping&nbsp;bit_maybe_i&nbsp;:&nbsp;bits(1)&nbsp;&lt;-&gt;&nbsp;string&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;0b1&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">&quot;i&quot;</span>,<br>
&nbsp;&nbsp;0b0&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(50, 85%, 80%)">&quot;&quot;</span><br>
}<br>
<br>
mapping&nbsp;bit_maybe_o&nbsp;:&nbsp;bits(1)&nbsp;&lt;-&gt;&nbsp;string&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;0b1&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">&quot;o&quot;</span>,<br>
&nbsp;&nbsp;0b0&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(50, 85%, 80%)">&quot;&quot;</span><br>
}<br>
<br>
mapping&nbsp;fence_bits&nbsp;:&nbsp;bits(4)&nbsp;&lt;-&gt;&nbsp;string&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;i&nbsp;:&nbsp;bits(1)&nbsp;@&nbsp;o&nbsp;:&nbsp;bits(1)&nbsp;@&nbsp;r&nbsp;:&nbsp;bits(1)&nbsp;@&nbsp;w&nbsp;:&nbsp;bits(1)&nbsp;&lt;-&gt;&nbsp;bit_maybe_i(i)&nbsp;^&nbsp;bit_maybe_o(o)&nbsp;^&nbsp;bit_maybe_r(r)&nbsp;^&nbsp;bit_maybe_w(w)<br>
}<br>
<br>
mapping&nbsp;clause&nbsp;assembly&nbsp;=&nbsp;FENCE(pred,&nbsp;succ)<br>
&nbsp;&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">&quot;fence&quot;&nbsp;^&nbsp;spc()&nbsp;^&nbsp;fence_bits(pred)&nbsp;^&nbsp;sep()&nbsp;^&nbsp;fence_bits(succ)</span><br>
<br>
/*&nbsp;******************************************************************&nbsp;*/<br>
union&nbsp;clause&nbsp;ast&nbsp;=&nbsp;FENCE_TSO&nbsp;:&nbsp;(bits(4),&nbsp;bits(4))<br>
<br>
mapping&nbsp;clause&nbsp;encdec&nbsp;=&nbsp;<span style="background-color: hsl(50, 85%, 80%)">FENCE_TSO(pred,&nbsp;succ)</span><br>
&nbsp;&nbsp;&lt;-&gt;&nbsp;0b1000&nbsp;@&nbsp;pred&nbsp;@&nbsp;succ&nbsp;@&nbsp;0b00000&nbsp;@&nbsp;0b000&nbsp;@&nbsp;0b00000&nbsp;@&nbsp;0b0001111<br>
<br>
$ifdef&nbsp;FEATURE_UNION_BARRIER<br>
<br>
function&nbsp;clause&nbsp;execute&nbsp;(FENCE_TSO(pred,&nbsp;succ))&nbsp;=&nbsp;<span style="background-color: hsl(50, 85%, 80%)">{<br>
&nbsp;&nbsp;match&nbsp;(pred,&nbsp;succ)&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;(_&nbsp;:&nbsp;bits(2)&nbsp;@&nbsp;0b11,&nbsp;_&nbsp;:&nbsp;bits(2)&nbsp;@&nbsp;0b11)&nbsp;=&gt;&nbsp;<span style="background-color: hsl(50, 85%, 75%)">__barrier(Barrier_RISCV_tso())</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;(_&nbsp;:&nbsp;bits(2)&nbsp;@&nbsp;0b00,&nbsp;_&nbsp;:&nbsp;bits(2)&nbsp;@&nbsp;0b00)&nbsp;=&gt;&nbsp;<span style="background-color: hsl(50, 85%, 75%)">()</span>,<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;_&nbsp;=&gt;&nbsp;<span style="background-color: hsl(50, 85%, 75%)">{&nbsp;print(&quot;FIXME:&nbsp;unsupported&nbsp;fence&quot;);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;()&nbsp;}</span><br>
&nbsp;&nbsp;};<br>
&nbsp;&nbsp;RETIRE_SUCCESS<br>
}</span><br>
<br>
$else<br>
<br>
function&nbsp;clause&nbsp;execute&nbsp;(FENCE_TSO(pred,&nbsp;succ))&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;match&nbsp;(pred,&nbsp;succ)&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;(_&nbsp;:&nbsp;bits(2)&nbsp;@&nbsp;0b11,&nbsp;_&nbsp;:&nbsp;bits(2)&nbsp;@&nbsp;0b11)&nbsp;=&gt;&nbsp;__barrier(Barrier_RISCV_tso),<br>
&nbsp;&nbsp;&nbsp;&nbsp;(_&nbsp;:&nbsp;bits(2)&nbsp;@&nbsp;0b00,&nbsp;_&nbsp;:&nbsp;bits(2)&nbsp;@&nbsp;0b00)&nbsp;=&gt;&nbsp;(),<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;_&nbsp;=&gt;&nbsp;{&nbsp;print(&quot;FIXME:&nbsp;unsupported&nbsp;fence&quot;);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;()&nbsp;}<br>
&nbsp;&nbsp;};<br>
&nbsp;&nbsp;RETIRE_SUCCESS<br>
}<br>
<br>
$endif<br>
<br>
mapping&nbsp;clause&nbsp;assembly&nbsp;=&nbsp;FENCE_TSO(pred,&nbsp;succ)<br>
&nbsp;&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(50, 85%, 80%)">&quot;fence.tso&quot;&nbsp;^&nbsp;spc()&nbsp;^&nbsp;fence_bits(pred)&nbsp;^&nbsp;sep()&nbsp;^&nbsp;fence_bits(succ)</span><br>
<br>
/*&nbsp;******************************************************************&nbsp;*/<br>
union&nbsp;clause&nbsp;ast&nbsp;=&nbsp;FENCEI&nbsp;:&nbsp;unit<br>
<br>
mapping&nbsp;clause&nbsp;encdec&nbsp;=&nbsp;<span style="background-color: hsl(220, 85%, 80%)">FENCEI()</span><br>
&nbsp;&nbsp;&lt;-&gt;&nbsp;0b000000000000&nbsp;@&nbsp;0b00000&nbsp;@&nbsp;0b001&nbsp;@&nbsp;0b00000&nbsp;@&nbsp;0b0001111<br>
<br>
/*&nbsp;fence.i&nbsp;is&nbsp;a&nbsp;nop&nbsp;for&nbsp;the&nbsp;memory&nbsp;model&nbsp;*/<br>
function&nbsp;clause&nbsp;execute&nbsp;FENCEI()&nbsp;=&nbsp;<span style="background-color: hsl(220, 85%, 80%)">{&nbsp;/*&nbsp;__barrier(Barrier_RISCV_i);&nbsp;*/&nbsp;RETIRE_SUCCESS&nbsp;}</span><br>
<br>
mapping&nbsp;clause&nbsp;assembly&nbsp;=&nbsp;FENCEI()&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">&quot;fence.i&quot;</span><br>
<br>
/*&nbsp;******************************************************************&nbsp;*/<br>
union&nbsp;clause&nbsp;ast&nbsp;=&nbsp;ECALL&nbsp;:&nbsp;unit<br>
<br>
mapping&nbsp;clause&nbsp;encdec&nbsp;=&nbsp;<span style="background-color: hsl(220, 85%, 80%)">ECALL()</span><br>
&nbsp;&nbsp;&lt;-&gt;&nbsp;0b000000000000&nbsp;@&nbsp;0b00000&nbsp;@&nbsp;0b000&nbsp;@&nbsp;0b00000&nbsp;@&nbsp;0b1110011<br>
<br>
function&nbsp;clause&nbsp;execute&nbsp;ECALL()&nbsp;=&nbsp;<span style="background-color: hsl(220, 85%, 80%)">{<br>
&nbsp;&nbsp;let&nbsp;t&nbsp;:&nbsp;sync_exception&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;{&nbsp;trap&nbsp;=&nbsp;match&nbsp;(cur_privilege)&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 75%)">E_U_EnvCall()</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Supervisor&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 75%)">E_S_EnvCall()</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Machine&nbsp;&nbsp;&nbsp;&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 75%)">E_M_EnvCall()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;excinfo&nbsp;=&nbsp;(None()&nbsp;:&nbsp;option(xlenbits)),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ext&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;None()&nbsp;};<br>
&nbsp;&nbsp;set_next_pc(exception_handler(cur_privilege,&nbsp;CTL_TRAP(t),&nbsp;PC));<br>
&nbsp;&nbsp;RETIRE_FAIL<br>
}</span><br>
<br>
mapping&nbsp;clause&nbsp;assembly&nbsp;=&nbsp;ECALL()&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">&quot;ecall&quot;</span><br>
<br>
/*&nbsp;******************************************************************&nbsp;*/<br>
union&nbsp;clause&nbsp;ast&nbsp;=&nbsp;MRET&nbsp;:&nbsp;unit<br>
<br>
mapping&nbsp;clause&nbsp;encdec&nbsp;=&nbsp;<span style="background-color: hsl(220, 85%, 80%)">MRET()</span><br>
&nbsp;&nbsp;&lt;-&gt;&nbsp;0b0011000&nbsp;@&nbsp;0b00010&nbsp;@&nbsp;0b00000&nbsp;@&nbsp;0b000&nbsp;@&nbsp;0b00000&nbsp;@&nbsp;0b1110011<br>
<br>
function&nbsp;clause&nbsp;execute&nbsp;MRET()&nbsp;=&nbsp;<span style="background-color: hsl(220, 85%, 80%)">{<br>
&nbsp;&nbsp;if&nbsp;&nbsp;&nbsp;cur_privilege&nbsp;!=&nbsp;Machine<br>
&nbsp;&nbsp;then&nbsp;<span style="background-color: hsl(50, 85%, 80%)">handle_illegal()</span><br>
&nbsp;&nbsp;else&nbsp;<span style="background-color: hsl(220, 85%, 75%)">if&nbsp;~(ext_check_xret_priv&nbsp;(Machine))<br>
&nbsp;&nbsp;then&nbsp;ext_fail_xret_priv&nbsp;()<br>
&nbsp;&nbsp;else&nbsp;set_next_pc(exception_handler(cur_privilege,&nbsp;CTL_MRET(),&nbsp;PC))</span>;<br>
&nbsp;&nbsp;RETIRE_FAIL<br>
}</span><br>
<br>
mapping&nbsp;clause&nbsp;assembly&nbsp;=&nbsp;MRET()&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">&quot;mret&quot;</span><br>
<br>
/*&nbsp;******************************************************************&nbsp;*/<br>
union&nbsp;clause&nbsp;ast&nbsp;=&nbsp;SRET&nbsp;:&nbsp;unit<br>
<br>
mapping&nbsp;clause&nbsp;encdec&nbsp;=&nbsp;<span style="background-color: hsl(220, 85%, 80%)">SRET()</span><br>
&nbsp;&nbsp;&lt;-&gt;&nbsp;0b0001000&nbsp;@&nbsp;0b00010&nbsp;@&nbsp;0b00000&nbsp;@&nbsp;0b000&nbsp;@&nbsp;0b00000&nbsp;@&nbsp;0b1110011<br>
<br>
function&nbsp;clause&nbsp;execute&nbsp;SRET()&nbsp;=&nbsp;<span style="background-color: hsl(220, 85%, 80%)">{<br>
&nbsp;&nbsp;let&nbsp;sret_illegal&nbsp;:&nbsp;bool&nbsp;=&nbsp;match&nbsp;cur_privilege&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;User&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt;&nbsp;<span style="background-color: hsl(50, 85%, 80%)">true</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;Supervisor&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 75%)">~&nbsp;(haveSupMode&nbsp;())&nbsp;|&nbsp;mstatus.TSR()&nbsp;==&nbsp;0b1</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;Machine&nbsp;&nbsp;&nbsp;&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 75%)">~&nbsp;(haveSupMode&nbsp;())</span><br>
&nbsp;&nbsp;};<br>
&nbsp;&nbsp;if&nbsp;&nbsp;&nbsp;sret_illegal<br>
&nbsp;&nbsp;then&nbsp;<span style="background-color: hsl(220, 85%, 75%)">handle_illegal()</span><br>
&nbsp;&nbsp;else&nbsp;<span style="background-color: hsl(220, 85%, 75%)">if&nbsp;~(ext_check_xret_priv&nbsp;(Supervisor))<br>
&nbsp;&nbsp;then&nbsp;ext_fail_xret_priv&nbsp;()<br>
&nbsp;&nbsp;else&nbsp;set_next_pc(exception_handler(cur_privilege,&nbsp;CTL_SRET(),&nbsp;PC))</span>;<br>
&nbsp;&nbsp;RETIRE_FAIL<br>
}</span><br>
<br>
mapping&nbsp;clause&nbsp;assembly&nbsp;=&nbsp;SRET()&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">&quot;sret&quot;</span><br>
<br>
/*&nbsp;******************************************************************&nbsp;*/<br>
union&nbsp;clause&nbsp;ast&nbsp;=&nbsp;EBREAK&nbsp;:&nbsp;unit<br>
<br>
mapping&nbsp;clause&nbsp;encdec&nbsp;=&nbsp;<span style="background-color: hsl(220, 85%, 80%)">EBREAK()</span><br>
&nbsp;&nbsp;&lt;-&gt;&nbsp;0b000000000001&nbsp;@&nbsp;0b00000&nbsp;@&nbsp;0b000&nbsp;@&nbsp;0b00000&nbsp;@&nbsp;0b1110011<br>
<br>
function&nbsp;clause&nbsp;execute&nbsp;EBREAK()&nbsp;=&nbsp;<span style="background-color: hsl(220, 85%, 80%)">{<br>
&nbsp;&nbsp;handle_exception(E_Breakpoint());<br>
&nbsp;&nbsp;RETIRE_FAIL<br>
}</span><br>
<br>
mapping&nbsp;clause&nbsp;assembly&nbsp;=&nbsp;EBREAK()&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">&quot;ebreak&quot;</span><br>
<br>
/*&nbsp;******************************************************************&nbsp;*/<br>
union&nbsp;clause&nbsp;ast&nbsp;=&nbsp;WFI&nbsp;:&nbsp;unit<br>
<br>
mapping&nbsp;clause&nbsp;encdec&nbsp;=&nbsp;<span style="background-color: hsl(220, 85%, 80%)">WFI()</span><br>
&nbsp;&nbsp;&lt;-&gt;&nbsp;0b000100000101&nbsp;@&nbsp;0b00000&nbsp;@&nbsp;0b000&nbsp;@&nbsp;0b00000&nbsp;@&nbsp;0b1110011<br>
<br>
function&nbsp;clause&nbsp;execute&nbsp;WFI()&nbsp;=<br>
&nbsp;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">match&nbsp;cur_privilege&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;Machine&nbsp;&nbsp;&nbsp;&nbsp;=&gt;&nbsp;<span style="background-color: hsl(50, 85%, 80%)">{&nbsp;platform_wfi();&nbsp;RETIRE_SUCCESS&nbsp;}</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;Supervisor&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 75%)">if&nbsp;&nbsp;&nbsp;mstatus.TW()&nbsp;==&nbsp;0b1<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;<span style="background-color: hsl(220, 85%, 70%)">{&nbsp;handle_illegal();&nbsp;RETIRE_FAIL&nbsp;}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;<span style="background-color: hsl(220, 85%, 70%)">{&nbsp;platform_wfi();&nbsp;RETIRE_SUCCESS&nbsp;}</span></span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;User&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt;&nbsp;<span style="background-color: hsl(50, 85%, 80%)">{&nbsp;handle_illegal();&nbsp;RETIRE_FAIL&nbsp;}</span><br>
&nbsp;&nbsp;}</span><br>
<br>
mapping&nbsp;clause&nbsp;assembly&nbsp;=&nbsp;WFI()&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">&quot;wfi&quot;</span><br>
<br>
/*&nbsp;******************************************************************&nbsp;*/<br>
union&nbsp;clause&nbsp;ast&nbsp;=&nbsp;SFENCE_VMA&nbsp;:&nbsp;(regidx,&nbsp;regidx)<br>
<br>
mapping&nbsp;clause&nbsp;encdec&nbsp;=&nbsp;<span style="background-color: hsl(220, 85%, 80%)">SFENCE_VMA(rs1,&nbsp;rs2)</span><br>
&nbsp;&nbsp;&lt;-&gt;&nbsp;0b0001001&nbsp;@&nbsp;rs2&nbsp;@&nbsp;rs1&nbsp;@&nbsp;0b000&nbsp;@&nbsp;0b00000&nbsp;@&nbsp;0b1110011<br>
<br>
function&nbsp;clause&nbsp;execute&nbsp;SFENCE_VMA(rs1,&nbsp;rs2)&nbsp;=&nbsp;<span style="background-color: hsl(220, 85%, 80%)">{<br>
&nbsp;&nbsp;let&nbsp;addr&nbsp;:&nbsp;option(xlenbits)&nbsp;=&nbsp;if&nbsp;rs1&nbsp;==&nbsp;0b00000&nbsp;then&nbsp;<span style="background-color: hsl(220, 85%, 75%)">None()</span>&nbsp;else&nbsp;<span style="background-color: hsl(220, 85%, 75%)">Some(X(rs1))</span>;<br>
&nbsp;&nbsp;let&nbsp;asid&nbsp;:&nbsp;option(xlenbits)&nbsp;=&nbsp;if&nbsp;rs2&nbsp;==&nbsp;0b00000&nbsp;then&nbsp;<span style="background-color: hsl(220, 85%, 75%)">None()</span>&nbsp;else&nbsp;<span style="background-color: hsl(50, 85%, 80%)">Some(X(rs2))</span>;<br>
&nbsp;&nbsp;match&nbsp;cur_privilege&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;User&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt;&nbsp;<span style="background-color: hsl(50, 85%, 80%)">{&nbsp;handle_illegal();&nbsp;RETIRE_FAIL&nbsp;}</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;Supervisor&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 75%)">match&nbsp;(architecture(get_mstatus_SXL(mstatus)),&nbsp;mstatus.TVM())&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(Some(_),&nbsp;0b1)&nbsp;&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 70%)">{&nbsp;handle_illegal();&nbsp;RETIRE_FAIL&nbsp;}</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(Some(_),&nbsp;0b0)&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 70%)">{&nbsp;flush_TLB(asid,&nbsp;addr);&nbsp;RETIRE_SUCCESS&nbsp;}</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(_,&nbsp;_)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt;&nbsp;<span style="background-color: hsl(50, 85%, 80%)">internal_error(&quot;unimplemented&nbsp;sfence&nbsp;architecture&quot;)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;Machine&nbsp;&nbsp;&nbsp;&nbsp;=&gt;&nbsp;<span style="background-color: hsl(220, 85%, 75%)">{&nbsp;flush_TLB(asid,&nbsp;addr);&nbsp;RETIRE_SUCCESS&nbsp;}</span><br>
&nbsp;&nbsp;}<br>
}</span><br>
<br>
mapping&nbsp;clause&nbsp;assembly&nbsp;=&nbsp;SFENCE_VMA(rs1,&nbsp;rs2)<br>
&nbsp;&nbsp;&lt;-&gt;&nbsp;<span style="background-color: hsl(220, 85%, 80%)">&quot;sfence.vma&quot;&nbsp;^&nbsp;spc()&nbsp;^&nbsp;reg_name(rs1)&nbsp;^&nbsp;sep()&nbsp;^&nbsp;reg_name(rs2)</span><br>
<br>
</code>
</body>
</html>