<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>riscv_vmem_common</title></head>
<body>
<h1>riscv_vmem_common.sail (2/2) 100%</h1>
<code style="display: block">
/*&nbsp;Shared&nbsp;definitions&nbsp;for&nbsp;supervisor-mode&nbsp;page-table-entries&nbsp;and&nbsp;permission&nbsp;checks.<br>
&nbsp;*<br>
&nbsp;*&nbsp;These&nbsp;definitions&nbsp;are&nbsp;independent&nbsp;of&nbsp;xlen&nbsp;and&nbsp;do&nbsp;not&nbsp;involve<br>
&nbsp;*&nbsp;accessing&nbsp;physical&nbsp;memory.<br>
&nbsp;*/<br>
<br>
/*&nbsp;PageSize&nbsp;*/<br>
<br>
let&nbsp;PAGESIZE_BITS&nbsp;=&nbsp;12<br>
<br>
/*<br>
&nbsp;*&nbsp;Definitions&nbsp;for&nbsp;RV32,&nbsp;which&nbsp;has&nbsp;a&nbsp;single&nbsp;address&nbsp;translation&nbsp;mode:&nbsp;Sv32.<br>
&nbsp;*/<br>
<br>
type&nbsp;vaddr32&nbsp;=&nbsp;bits(32)<br>
type&nbsp;paddr32&nbsp;=&nbsp;bits(34)<br>
type&nbsp;pte32&nbsp;&nbsp;&nbsp;=&nbsp;bits(32)<br>
<br>
/*&nbsp;asid&nbsp;*/<br>
type&nbsp;asid32&nbsp;=&nbsp;bits(9)<br>
<br>
function&nbsp;curAsid32(satp&nbsp;:&nbsp;bits(32))&nbsp;-&gt;&nbsp;asid32&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;let&nbsp;s&nbsp;=&nbsp;Mk_Satp32(satp);<br>
&nbsp;&nbsp;s.Asid()<br>
}<br>
<br>
/*&nbsp;page&nbsp;table&nbsp;base&nbsp;from&nbsp;satp&nbsp;*/<br>
function&nbsp;curPTB32(satp&nbsp;:&nbsp;bits(32))&nbsp;-&gt;&nbsp;paddr32&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;let&nbsp;s&nbsp;:&nbsp;Satp32&nbsp;=&nbsp;Mk_Satp32(satp);<br>
&nbsp;&nbsp;shiftl(EXTZ(s.PPN()),&nbsp;PAGESIZE_BITS)<br>
}<br>
<br>
/*&nbsp;Sv32&nbsp;parameters&nbsp;and&nbsp;bitfield&nbsp;layouts&nbsp;*/<br>
<br>
let&nbsp;SV32_LEVEL_BITS&nbsp;=&nbsp;10<br>
let&nbsp;SV32_LEVELS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;2<br>
let&nbsp;PTE32_LOG_SIZE&nbsp;&nbsp;=&nbsp;2<br>
let&nbsp;PTE32_SIZE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;4<br>
<br>
bitfield&nbsp;SV32_Vaddr&nbsp;:&nbsp;vaddr32&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;VPNi&nbsp;&nbsp;:&nbsp;31&nbsp;..&nbsp;12,<br>
&nbsp;&nbsp;PgOfs&nbsp;:&nbsp;11&nbsp;..&nbsp;0<br>
}<br>
<br>
bitfield&nbsp;SV32_Paddr&nbsp;:&nbsp;paddr32&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;PPNi&nbsp;&nbsp;:&nbsp;33&nbsp;..&nbsp;12,<br>
&nbsp;&nbsp;PgOfs&nbsp;:&nbsp;11&nbsp;..&nbsp;0<br>
}<br>
<br>
bitfield&nbsp;SV32_PTE&nbsp;:&nbsp;pte32&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;PPNi&nbsp;&nbsp;:&nbsp;31&nbsp;..&nbsp;10,<br>
&nbsp;&nbsp;RSW&nbsp;&nbsp;&nbsp;:&nbsp;9&nbsp;&nbsp;..&nbsp;8,<br>
&nbsp;&nbsp;BITS&nbsp;&nbsp;:&nbsp;7&nbsp;&nbsp;..&nbsp;0<br>
}<br>
<br>
/*<br>
&nbsp;*&nbsp;Definitions&nbsp;for&nbsp;RV64,&nbsp;which&nbsp;has&nbsp;two&nbsp;defined&nbsp;address&nbsp;translation&nbsp;modes:&nbsp;Sv39&nbsp;and&nbsp;Sv48.<br>
&nbsp;*/<br>
<br>
/*&nbsp;Sv48&nbsp;and&nbsp;Sv64&nbsp;are&nbsp;reserved&nbsp;but&nbsp;not&nbsp;defined.&nbsp;&nbsp;The&nbsp;size&nbsp;of&nbsp;the&nbsp;VPN<br>
&nbsp;*&nbsp;increases&nbsp;by&nbsp;9&nbsp;bits&nbsp;through&nbsp;Sv39,&nbsp;Sv48&nbsp;and&nbsp;Sv57,&nbsp;but&nbsp;not&nbsp;for&nbsp;Sv64.<br>
&nbsp;*&nbsp;Also,&nbsp;the&nbsp;45-bit&nbsp;size&nbsp;of&nbsp;the&nbsp;VPN&nbsp;for&nbsp;Sv57&nbsp;exceeds&nbsp;the&nbsp;44-bit&nbsp;size<br>
&nbsp;*&nbsp;of&nbsp;the&nbsp;PPN&nbsp;in&nbsp;satp64.&nbsp;&nbsp;Due&nbsp;to&nbsp;these&nbsp;corner&nbsp;cases,&nbsp;it&nbsp;is&nbsp;unlikely<br>
&nbsp;*&nbsp;that&nbsp;definitions&nbsp;can&nbsp;be&nbsp;shared&nbsp;across&nbsp;all&nbsp;four&nbsp;schemes,&nbsp;so&nbsp;separate<br>
&nbsp;*&nbsp;definitions&nbsp;might&nbsp;eventually&nbsp;be&nbsp;needed&nbsp;for&nbsp;each&nbsp;translation&nbsp;mode.<br>
&nbsp;*<br>
&nbsp;*&nbsp;But&nbsp;to&nbsp;keep&nbsp;things&nbsp;simple&nbsp;for&nbsp;now,&nbsp;since&nbsp;Sv39&nbsp;and&nbsp;Sv48&nbsp;have&nbsp;the<br>
&nbsp;*&nbsp;same&nbsp;PPN&nbsp;size,&nbsp;we&nbsp;share&nbsp;some&nbsp;definitions.<br>
&nbsp;*/<br>
<br>
type&nbsp;paddr64&nbsp;=&nbsp;bits(56)<br>
type&nbsp;pte64&nbsp;&nbsp;&nbsp;=&nbsp;bits(64)<br>
<br>
/*&nbsp;asid&nbsp;*/<br>
<br>
type&nbsp;asid64&nbsp;=&nbsp;bits(16)<br>
<br>
function&nbsp;curAsid64(satp&nbsp;:&nbsp;bits(64))&nbsp;-&gt;&nbsp;asid64&nbsp;=&nbsp;<span style="background-color: hsl(120, 85%, 80%)">{<br>
&nbsp;&nbsp;let&nbsp;s&nbsp;=&nbsp;Mk_Satp64(satp);<br>
&nbsp;&nbsp;s.Asid()<br>
}</span><br>
<br>
/*&nbsp;page&nbsp;table&nbsp;base&nbsp;from&nbsp;satp&nbsp;*/<br>
function&nbsp;curPTB64(satp&nbsp;:&nbsp;bits(64))&nbsp;-&gt;&nbsp;paddr64&nbsp;=&nbsp;<span style="background-color: hsl(120, 85%, 80%)">{<br>
&nbsp;&nbsp;let&nbsp;s&nbsp;=&nbsp;Mk_Satp64(satp);<br>
&nbsp;&nbsp;shiftl(EXTZ(s.PPN()),&nbsp;PAGESIZE_BITS)<br>
}</span><br>
<br>
/*&nbsp;Sv39&nbsp;parameters&nbsp;and&nbsp;bitfield&nbsp;layouts&nbsp;*/<br>
<br>
let&nbsp;SV39_LEVEL_BITS&nbsp;=&nbsp;9<br>
let&nbsp;SV39_LEVELS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;3<br>
let&nbsp;PTE39_LOG_SIZE&nbsp;&nbsp;=&nbsp;3<br>
let&nbsp;PTE39_SIZE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;8<br>
<br>
type&nbsp;vaddr39&nbsp;=&nbsp;bits(39)<br>
<br>
bitfield&nbsp;SV39_Vaddr&nbsp;:&nbsp;vaddr39&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;VPNi&nbsp;&nbsp;:&nbsp;38&nbsp;..&nbsp;12,<br>
&nbsp;&nbsp;PgOfs&nbsp;:&nbsp;11&nbsp;..&nbsp;0<br>
}<br>
<br>
bitfield&nbsp;SV39_Paddr&nbsp;:&nbsp;paddr64&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;PPNi&nbsp;&nbsp;:&nbsp;55&nbsp;..&nbsp;12,<br>
&nbsp;&nbsp;PgOfs&nbsp;:&nbsp;11&nbsp;..&nbsp;0<br>
}<br>
<br>
bitfield&nbsp;SV39_PTE&nbsp;:&nbsp;pte64&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;Ext&nbsp;&nbsp;&nbsp;:&nbsp;63&nbsp;..&nbsp;54,<br>
&nbsp;&nbsp;PPNi&nbsp;&nbsp;:&nbsp;53&nbsp;..&nbsp;10,<br>
&nbsp;&nbsp;RSW&nbsp;&nbsp;&nbsp;:&nbsp;9&nbsp;&nbsp;..&nbsp;8,<br>
&nbsp;&nbsp;BITS&nbsp;&nbsp;:&nbsp;7&nbsp;&nbsp;..&nbsp;0<br>
}<br>
<br>
/*&nbsp;Sv48&nbsp;parameters&nbsp;and&nbsp;bitfield&nbsp;layouts&nbsp;*/<br>
<br>
let&nbsp;SV48_LEVEL_BITS&nbsp;=&nbsp;9<br>
let&nbsp;SV48_LEVELS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;4<br>
let&nbsp;PTE48_LOG_SIZE&nbsp;&nbsp;=&nbsp;3<br>
let&nbsp;PTE48_SIZE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;8<br>
<br>
type&nbsp;vaddr48&nbsp;=&nbsp;bits(48)<br>
type&nbsp;pte48&nbsp;&nbsp;&nbsp;=&nbsp;bits(64)<br>
<br>
bitfield&nbsp;SV48_Vaddr&nbsp;:&nbsp;vaddr48&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;VPNi&nbsp;&nbsp;:&nbsp;38&nbsp;..&nbsp;12,<br>
&nbsp;&nbsp;PgOfs&nbsp;:&nbsp;11&nbsp;..&nbsp;0<br>
}<br>
<br>
bitfield&nbsp;SV48_Paddr&nbsp;:&nbsp;paddr64&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;PPNi&nbsp;&nbsp;:&nbsp;55&nbsp;..&nbsp;12,<br>
&nbsp;&nbsp;PgOfs&nbsp;:&nbsp;11&nbsp;..&nbsp;0<br>
}<br>
<br>
bitfield&nbsp;SV48_PTE&nbsp;:&nbsp;pte48&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;Ext&nbsp;&nbsp;&nbsp;:&nbsp;63&nbsp;..&nbsp;54,<br>
&nbsp;&nbsp;PPNi&nbsp;&nbsp;:&nbsp;53&nbsp;..&nbsp;10,<br>
&nbsp;&nbsp;RSW&nbsp;&nbsp;&nbsp;:&nbsp;9&nbsp;&nbsp;..&nbsp;8,<br>
&nbsp;&nbsp;BITS&nbsp;&nbsp;:&nbsp;7&nbsp;&nbsp;..&nbsp;0<br>
}<br>
<br>
/*&nbsp;The&nbsp;types&nbsp;below&nbsp;are&nbsp;parameterized&nbsp;by&nbsp;'paddr&nbsp;and&nbsp;'pte&nbsp;to&nbsp;support<br>
&nbsp;*&nbsp;various&nbsp;architectural&nbsp;widths&nbsp;(e.g.&nbsp;RV32,&nbsp;RV64).&nbsp;&nbsp;ext_ptw&nbsp;supports<br>
&nbsp;*&nbsp;extensions&nbsp;to&nbsp;the&nbsp;default&nbsp;address&nbsp;translation&nbsp;and&nbsp;page-table-walk.<br>
&nbsp;*/<br>
<br>
/*&nbsp;Result&nbsp;of&nbsp;a&nbsp;page-table&nbsp;walk.&nbsp;&nbsp;*/<br>
<br>
union&nbsp;PTW_Result('paddr&nbsp;:&nbsp;Type,&nbsp;'pte&nbsp;:&nbsp;Type)&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;PTW_Success:&nbsp;('paddr,&nbsp;'pte,&nbsp;'paddr,&nbsp;nat,&nbsp;bool,&nbsp;ext_ptw),<br>
&nbsp;&nbsp;PTW_Failure:&nbsp;(PTW_Error,&nbsp;ext_ptw)<br>
}<br>
<br>
/*&nbsp;Result&nbsp;of&nbsp;address&nbsp;translation&nbsp;*/<br>
<br>
union&nbsp;TR_Result('paddr&nbsp;:&nbsp;Type,&nbsp;'failure&nbsp;:&nbsp;Type)&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;TR_Address&nbsp;:&nbsp;('paddr,&nbsp;ext_ptw),<br>
&nbsp;&nbsp;TR_Failure&nbsp;:&nbsp;('failure,&nbsp;ext_ptw)<br>
}<br>
</code>
</body>
</html>