<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>riscv_platform</title></head>
<body>
<h1>riscv_platform.sail (41/131) 31%</h1>
<code style="display: block">
/*&nbsp;Platform-specific&nbsp;definitions,&nbsp;and&nbsp;basic&nbsp;MMIO&nbsp;devices.&nbsp;*/<br>
<br>
/*&nbsp;Current&nbsp;constraints&nbsp;on&nbsp;this&nbsp;implementation&nbsp;are:<br>
&nbsp;&nbsp;&nbsp;-&nbsp;it&nbsp;cannot&nbsp;access&nbsp;memory&nbsp;directly,&nbsp;but&nbsp;instead&nbsp;provides&nbsp;definitions&nbsp;for&nbsp;the&nbsp;physical&nbsp;memory&nbsp;model<br>
&nbsp;&nbsp;&nbsp;-&nbsp;it&nbsp;can&nbsp;access&nbsp;system&nbsp;register&nbsp;state,&nbsp;needed&nbsp;to&nbsp;manipulate&nbsp;interrupt&nbsp;bits<br>
&nbsp;&nbsp;&nbsp;-&nbsp;it&nbsp;relies&nbsp;on&nbsp;externs&nbsp;to&nbsp;get&nbsp;platform&nbsp;address&nbsp;information&nbsp;and&nbsp;doesn't&nbsp;hardcode&nbsp;them<br>
*/<br>
<br>
val&nbsp;elf_tohost&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;ocaml:&nbsp;&quot;Elf_loader.elf_tohost&quot;,<br>
&nbsp;&nbsp;interpreter:&nbsp;&quot;Elf_loader.elf_tohost&quot;,<br>
&nbsp;&nbsp;c:&nbsp;&quot;elf_tohost&quot;<br>
}&nbsp;:&nbsp;&nbsp;unit&nbsp;-&gt;&nbsp;int<br>
<br>
val&nbsp;elf_entry&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;ocaml:&nbsp;&quot;Elf_loader.elf_entry&quot;,<br>
&nbsp;&nbsp;interpreter:&nbsp;&quot;Elf_loader.elf_entry&quot;,<br>
&nbsp;&nbsp;c:&nbsp;&quot;elf_entry&quot;<br>
}&nbsp;:&nbsp;unit&nbsp;-&gt;&nbsp;int<br>
<br>
/*&nbsp;Main&nbsp;memory&nbsp;*/<br>
val&nbsp;plat_ram_base&nbsp;=&nbsp;{c:&nbsp;&quot;plat_ram_base&quot;,&nbsp;ocaml:&nbsp;&quot;Platform.dram_base&quot;,&nbsp;interpreter:&nbsp;&quot;Platform.dram_base&quot;,&nbsp;lem:&nbsp;&quot;plat_ram_base&quot;}&nbsp;:&nbsp;unit&nbsp;-&gt;&nbsp;xlenbits<br>
val&nbsp;plat_ram_size&nbsp;=&nbsp;{c:&nbsp;&quot;plat_ram_size&quot;,&nbsp;ocaml:&nbsp;&quot;Platform.dram_size&quot;,&nbsp;interpreter:&nbsp;&quot;Platform.dram_size&quot;,&nbsp;lem:&nbsp;&quot;plat_ram_size&quot;}&nbsp;:&nbsp;unit&nbsp;-&gt;&nbsp;xlenbits<br>
<br>
/*&nbsp;whether&nbsp;the&nbsp;platform&nbsp;supports&nbsp;PMP&nbsp;configurations&nbsp;*/<br>
val&nbsp;plat_enable_pmp&nbsp;=&nbsp;{ocaml:&nbsp;&quot;Platform.enable_pmp&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;interpreter:&nbsp;&quot;Platform.enable_pmp&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c:&nbsp;&quot;plat_enable_pmp&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lem:&nbsp;&quot;plat_enable_pmp&quot;}&nbsp;:&nbsp;unit&nbsp;-&gt;&nbsp;bool<br>
<br>
/*&nbsp;whether&nbsp;the&nbsp;MMU&nbsp;should&nbsp;update&nbsp;dirty&nbsp;bits&nbsp;in&nbsp;PTEs&nbsp;*/<br>
val&nbsp;plat_enable_dirty_update&nbsp;=&nbsp;{ocaml:&nbsp;&quot;Platform.enable_dirty_update&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;interpreter:&nbsp;&quot;Platform.enable_dirty_update&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c:&nbsp;&quot;plat_enable_dirty_update&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lem:&nbsp;&quot;plat_enable_dirty_update&quot;}&nbsp;:&nbsp;unit&nbsp;-&gt;&nbsp;bool<br>
<br>
/*&nbsp;whether&nbsp;the&nbsp;platform&nbsp;supports&nbsp;misaligned&nbsp;accesses&nbsp;without&nbsp;trapping&nbsp;to&nbsp;M-mode.&nbsp;if&nbsp;false,<br>
&nbsp;*&nbsp;misaligned&nbsp;loads/stores&nbsp;are&nbsp;trapped&nbsp;to&nbsp;Machine&nbsp;mode.<br>
&nbsp;*/<br>
val&nbsp;plat_enable_misaligned_access&nbsp;=&nbsp;{ocaml:&nbsp;&quot;Platform.enable_misaligned_access&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;interpreter:&nbsp;&quot;Platform.enable_misaligned_access&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c:&nbsp;&quot;plat_enable_misaligned_access&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lem:&nbsp;&quot;plat_enable_misaligned_access&quot;}&nbsp;:&nbsp;unit&nbsp;-&gt;&nbsp;bool<br>
<br>
/*&nbsp;whether&nbsp;mtval&nbsp;stores&nbsp;the&nbsp;bits&nbsp;of&nbsp;a&nbsp;faulting&nbsp;instruction&nbsp;on&nbsp;illegal&nbsp;instruction&nbsp;exceptions&nbsp;*/<br>
val&nbsp;plat_mtval_has_illegal_inst_bits&nbsp;=&nbsp;{ocaml:&nbsp;&quot;Platform.mtval_has_illegal_inst_bits&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;interpreter:&nbsp;&quot;Platform.mtval_has_illegal_inst_bits&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c:&nbsp;&quot;plat_mtval_has_illegal_inst_bits&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lem:&nbsp;&quot;plat_mtval_has_illegal_inst_bits&quot;}&nbsp;:&nbsp;unit&nbsp;-&gt;&nbsp;bool<br>
<br>
/*&nbsp;ROM&nbsp;holding&nbsp;reset&nbsp;vector&nbsp;and&nbsp;device-tree&nbsp;DTB&nbsp;*/<br>
val&nbsp;plat_rom_base&nbsp;&nbsp;&nbsp;=&nbsp;{ocaml:&nbsp;&quot;Platform.rom_base&quot;,&nbsp;interpreter:&nbsp;&quot;Platform.rom_base&quot;,&nbsp;c:&nbsp;&quot;plat_rom_base&quot;,&nbsp;lem:&nbsp;&quot;plat_rom_base&quot;}&nbsp;:&nbsp;unit&nbsp;-&gt;&nbsp;xlenbits<br>
val&nbsp;plat_rom_size&nbsp;&nbsp;&nbsp;=&nbsp;{ocaml:&nbsp;&quot;Platform.rom_size&quot;,&nbsp;interpreter:&nbsp;&quot;Platform.rom_size&quot;,&nbsp;c:&nbsp;&quot;plat_rom_size&quot;,&nbsp;lem:&nbsp;&quot;plat_rom_size&quot;}&nbsp;:&nbsp;unit&nbsp;-&gt;&nbsp;xlenbits<br>
<br>
/*&nbsp;Location&nbsp;of&nbsp;clock-interface,&nbsp;which&nbsp;should&nbsp;match&nbsp;with&nbsp;the&nbsp;spec&nbsp;in&nbsp;the&nbsp;DTB&nbsp;*/<br>
val&nbsp;plat_clint_base&nbsp;=&nbsp;{ocaml:&nbsp;&quot;Platform.clint_base&quot;,&nbsp;interpreter:&nbsp;&quot;Platform.clint_base&quot;,&nbsp;c:&nbsp;&quot;plat_clint_base&quot;,&nbsp;lem:&nbsp;&quot;plat_clint_base&quot;}&nbsp;:&nbsp;unit&nbsp;-&gt;&nbsp;xlenbits<br>
val&nbsp;plat_clint_size&nbsp;=&nbsp;{ocaml:&nbsp;&quot;Platform.clint_size&quot;,&nbsp;interpreter:&nbsp;&quot;Platform.clint_size&quot;,&nbsp;c:&nbsp;&quot;plat_clint_size&quot;,&nbsp;lem:&nbsp;&quot;plat_clint_size&quot;}&nbsp;:&nbsp;unit&nbsp;-&gt;&nbsp;xlenbits<br>
<br>
/*&nbsp;Location&nbsp;of&nbsp;HTIF&nbsp;ports&nbsp;*/<br>
val&nbsp;plat_htif_tohost&nbsp;=&nbsp;{ocaml:&nbsp;&quot;Platform.htif_tohost&quot;,&nbsp;c:&nbsp;&quot;plat_htif_tohost&quot;,&nbsp;lem:&nbsp;&quot;plat_htif_tohost&quot;}&nbsp;:&nbsp;unit&nbsp;-&gt;&nbsp;xlenbits<br>
function&nbsp;plat_htif_tohost&nbsp;()&nbsp;=&nbsp;<span style="background-color: hsl(0, 85%, 80%)">to_bits(sizeof(xlen),&nbsp;elf_tohost&nbsp;())</span><br>
//&nbsp;todo:&nbsp;fromhost<br>
<br>
val&nbsp;phys_mem_segments&nbsp;:&nbsp;unit&nbsp;-&gt;&nbsp;list((xlenbits,&nbsp;xlenbits))<br>
function&nbsp;phys_mem_segments()&nbsp;=<br>
&nbsp;&nbsp;(plat_rom_base&nbsp;(),&nbsp;plat_rom_size&nbsp;())&nbsp;::<br>
&nbsp;&nbsp;(plat_ram_base&nbsp;(),&nbsp;plat_ram_size&nbsp;())&nbsp;::<br>
&nbsp;&nbsp;[||]<br>
<br>
/*&nbsp;Physical&nbsp;memory&nbsp;map&nbsp;predicates&nbsp;*/<br>
<br>
function&nbsp;within_phys_mem&nbsp;forall&nbsp;'n,&nbsp;'n&nbsp;&lt;=&nbsp;max_mem_access.&nbsp;(addr&nbsp;:&nbsp;xlenbits,&nbsp;width&nbsp;:&nbsp;atom('n))&nbsp;-&gt;&nbsp;bool&nbsp;=&nbsp;<span style="background-color: hsl(120, 85%, 80%)">{<br>
&nbsp;&nbsp;/*&nbsp;To&nbsp;avoid&nbsp;overflow&nbsp;issues&nbsp;when&nbsp;physical&nbsp;memory&nbsp;extends&nbsp;to&nbsp;the&nbsp;end<br>
&nbsp;&nbsp;&nbsp;*&nbsp;of&nbsp;the&nbsp;addressable&nbsp;range,&nbsp;we&nbsp;need&nbsp;to&nbsp;perform&nbsp;address&nbsp;bound&nbsp;checks<br>
&nbsp;&nbsp;&nbsp;*&nbsp;on&nbsp;unsigned&nbsp;unbounded&nbsp;integers.<br>
&nbsp;&nbsp;&nbsp;*/<br>
&nbsp;&nbsp;let&nbsp;addr_int&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;unsigned(addr);<br>
&nbsp;&nbsp;let&nbsp;ram_base_int&nbsp;=&nbsp;unsigned(plat_ram_base&nbsp;());<br>
&nbsp;&nbsp;let&nbsp;rom_base_int&nbsp;=&nbsp;unsigned(plat_rom_base&nbsp;());<br>
&nbsp;&nbsp;let&nbsp;ram_size_int&nbsp;=&nbsp;unsigned(plat_ram_size&nbsp;());<br>
&nbsp;&nbsp;let&nbsp;rom_size_int&nbsp;=&nbsp;unsigned(plat_rom_size&nbsp;());<br>
<br>
&nbsp;&nbsp;/*&nbsp;todo:&nbsp;iterate&nbsp;over&nbsp;segment&nbsp;list&nbsp;*/<br>
&nbsp;&nbsp;if&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;ram_base_int&nbsp;&lt;=&nbsp;addr_int<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&&nbsp;(addr_int&nbsp;+&nbsp;sizeof('n))&nbsp;&lt;=&nbsp;(ram_base_int&nbsp;+&nbsp;ram_size_int))<br>
&nbsp;&nbsp;then&nbsp;&nbsp;&nbsp;&nbsp;<span style="background-color: hsl(120, 85%, 75%)">true</span><br>
&nbsp;&nbsp;else&nbsp;<span style="background-color: hsl(120, 85%, 75%)">if&nbsp;(&nbsp;&nbsp;rom_base_int&nbsp;&lt;=&nbsp;addr_int<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&&nbsp;(addr_int&nbsp;+&nbsp;sizeof('n))&nbsp;&lt;=&nbsp;(rom_base_int&nbsp;+&nbsp;rom_size_int))<br>
&nbsp;&nbsp;then&nbsp;&nbsp;&nbsp;&nbsp;<span style="background-color: hsl(120, 85%, 70%)">true</span><br>
&nbsp;&nbsp;else&nbsp;<span style="background-color: hsl(120, 85%, 70%)">{<br>
&nbsp;&nbsp;&nbsp;&nbsp;print_platform(&quot;within_phys_mem:&nbsp;&quot;&nbsp;^&nbsp;BitStr(addr)&nbsp;^&nbsp;&quot;&nbsp;not&nbsp;within&nbsp;phys-mem:&quot;);<br>
&nbsp;&nbsp;&nbsp;&nbsp;print_platform(&quot;&nbsp;&nbsp;plat_rom_base:&nbsp;&quot;&nbsp;^&nbsp;BitStr(plat_rom_base&nbsp;()));<br>
&nbsp;&nbsp;&nbsp;&nbsp;print_platform(&quot;&nbsp;&nbsp;plat_rom_size:&nbsp;&quot;&nbsp;^&nbsp;BitStr(plat_rom_size&nbsp;()));<br>
&nbsp;&nbsp;&nbsp;&nbsp;print_platform(&quot;&nbsp;&nbsp;plat_ram_base:&nbsp;&quot;&nbsp;^&nbsp;BitStr(plat_ram_base&nbsp;()));<br>
&nbsp;&nbsp;&nbsp;&nbsp;print_platform(&quot;&nbsp;&nbsp;plat_ram_size:&nbsp;&quot;&nbsp;^&nbsp;BitStr(plat_ram_size&nbsp;()));<br>
&nbsp;&nbsp;&nbsp;&nbsp;false<br>
&nbsp;&nbsp;}</span></span><br>
}</span><br>
<br>
function&nbsp;within_clint&nbsp;forall&nbsp;'n,&nbsp;0&nbsp;&lt;&nbsp;'n&nbsp;&lt;=&nbsp;max_mem_access&nbsp;.&nbsp;(addr&nbsp;:&nbsp;xlenbits,&nbsp;width&nbsp;:&nbsp;atom('n))&nbsp;-&gt;&nbsp;bool&nbsp;=&nbsp;<span style="background-color: hsl(120, 85%, 80%)">{<br>
&nbsp;&nbsp;/*&nbsp;To&nbsp;avoid&nbsp;overflow&nbsp;issues&nbsp;when&nbsp;physical&nbsp;memory&nbsp;extends&nbsp;to&nbsp;the&nbsp;end<br>
&nbsp;&nbsp;&nbsp;*&nbsp;of&nbsp;the&nbsp;addressable&nbsp;range,&nbsp;we&nbsp;need&nbsp;to&nbsp;perform&nbsp;address&nbsp;bound&nbsp;checks<br>
&nbsp;&nbsp;&nbsp;*&nbsp;on&nbsp;unsigned&nbsp;unbounded&nbsp;integers.<br>
&nbsp;&nbsp;&nbsp;*/<br>
&nbsp;&nbsp;let&nbsp;addr_int&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;unsigned(addr);<br>
&nbsp;&nbsp;let&nbsp;clint_base_int&nbsp;=&nbsp;unsigned(plat_clint_base&nbsp;());<br>
&nbsp;&nbsp;let&nbsp;clint_size_int&nbsp;=&nbsp;unsigned(plat_clint_size&nbsp;());<br>
&nbsp;&nbsp;&nbsp;&nbsp;clint_base_int&nbsp;&lt;=&nbsp;addr_int<br>
&nbsp;&nbsp;&&nbsp;(addr_int&nbsp;+&nbsp;sizeof('n))&nbsp;&lt;=&nbsp;(clint_base_int&nbsp;+&nbsp;clint_size_int)<br>
}</span><br>
<br>
function&nbsp;within_htif_writable&nbsp;forall&nbsp;'n,&nbsp;0&nbsp;&lt;&nbsp;'n&nbsp;&lt;=&nbsp;max_mem_access&nbsp;.&nbsp;(addr&nbsp;:&nbsp;xlenbits,&nbsp;width&nbsp;:&nbsp;atom('n))&nbsp;-&gt;&nbsp;bool&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="background-color: hsl(120, 85%, 80%)">plat_htif_tohost()&nbsp;==&nbsp;addr&nbsp;|&nbsp;(plat_htif_tohost()&nbsp;+&nbsp;4&nbsp;==&nbsp;addr&nbsp;&&nbsp;width&nbsp;==&nbsp;4)</span><br>
<br>
function&nbsp;within_htif_readable&nbsp;forall&nbsp;'n,&nbsp;0&nbsp;&lt;&nbsp;'n&nbsp;&lt;=&nbsp;max_mem_access&nbsp;.&nbsp;(addr&nbsp;:&nbsp;xlenbits,&nbsp;width&nbsp;:&nbsp;atom('n))&nbsp;-&gt;&nbsp;bool&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="background-color: hsl(120, 85%, 80%)">plat_htif_tohost()&nbsp;==&nbsp;addr&nbsp;|&nbsp;(plat_htif_tohost()&nbsp;+&nbsp;4&nbsp;==&nbsp;addr&nbsp;&&nbsp;width&nbsp;==&nbsp;4)</span><br>
<br>
/*&nbsp;CLINT&nbsp;(Core&nbsp;Local&nbsp;Interruptor),&nbsp;based&nbsp;on&nbsp;Spike.&nbsp;*/<br>
<br>
val&nbsp;plat_insns_per_tick&nbsp;=&nbsp;{ocaml:&nbsp;&quot;Platform.insns_per_tick&quot;,&nbsp;interpreter:&nbsp;&quot;Platform.insns_per_tick&quot;,&nbsp;c:&nbsp;&quot;plat_insns_per_tick&quot;,&nbsp;lem:&nbsp;&quot;plat_insns_per_tick&quot;}&nbsp;:&nbsp;unit&nbsp;-&gt;&nbsp;int<br>
<br>
//&nbsp;assumes&nbsp;a&nbsp;single&nbsp;hart,&nbsp;since&nbsp;this&nbsp;typically&nbsp;is&nbsp;a&nbsp;vector&nbsp;of&nbsp;per-hart&nbsp;registers.<br>
register&nbsp;mtimecmp&nbsp;:&nbsp;bits(64)&nbsp;&nbsp;//&nbsp;memory-mapped&nbsp;internal&nbsp;clint&nbsp;register.<br>
<br>
/*&nbsp;CLINT&nbsp;memory-mapped&nbsp;IO&nbsp;*/<br>
<br>
/*&nbsp;relative&nbsp;address&nbsp;map:<br>
&nbsp;*<br>
&nbsp;*&nbsp;0000&nbsp;msip&nbsp;hart&nbsp;0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--&nbsp;memory-mapped&nbsp;software&nbsp;interrupt<br>
&nbsp;*&nbsp;0004&nbsp;msip&nbsp;hart&nbsp;1<br>
&nbsp;*&nbsp;4000&nbsp;mtimecmp&nbsp;hart&nbsp;0&nbsp;lo&nbsp;&nbsp;--&nbsp;memory-mapped&nbsp;timer&nbsp;thresholds<br>
&nbsp;*&nbsp;4004&nbsp;mtimecmp&nbsp;hart&nbsp;0&nbsp;hi<br>
&nbsp;*&nbsp;4008&nbsp;mtimecmp&nbsp;hart&nbsp;1&nbsp;lo<br>
&nbsp;*&nbsp;400c&nbsp;mtimecmp&nbsp;hart&nbsp;1&nbsp;hi<br>
&nbsp;*&nbsp;bff8&nbsp;mtime&nbsp;lo&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--&nbsp;memory-mapped&nbsp;clocktimer&nbsp;value<br>
&nbsp;*&nbsp;bffc&nbsp;mtime&nbsp;hi<br>
&nbsp;*/<br>
<br>
let&nbsp;MSIP_BASE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;xlenbits&nbsp;=&nbsp;EXTZ(0x00000)<br>
let&nbsp;MTIMECMP_BASE&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;xlenbits&nbsp;=&nbsp;EXTZ(0x04000)<br>
let&nbsp;MTIMECMP_BASE_HI&nbsp;:&nbsp;xlenbits&nbsp;=&nbsp;EXTZ(0x04004)<br>
let&nbsp;MTIME_BASE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;xlenbits&nbsp;=&nbsp;EXTZ(0x0bff8)<br>
let&nbsp;MTIME_BASE_HI&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;xlenbits&nbsp;=&nbsp;EXTZ(0x0bffc)<br>
<br>
val&nbsp;clint_load&nbsp;:&nbsp;forall&nbsp;'n,&nbsp;'n&nbsp;&gt;&nbsp;0.&nbsp;(AccessType(ext_access_type),&nbsp;xlenbits,&nbsp;int('n))&nbsp;-&gt;&nbsp;MemoryOpResult(bits(8&nbsp;*&nbsp;'n))&nbsp;effect&nbsp;{rreg}<br>
function&nbsp;clint_load(t,&nbsp;addr,&nbsp;width)&nbsp;=&nbsp;<span style="background-color: hsl(0, 85%, 80%)">{<br>
&nbsp;&nbsp;let&nbsp;addr&nbsp;=&nbsp;addr&nbsp;-&nbsp;plat_clint_base&nbsp;();<br>
&nbsp;&nbsp;/*&nbsp;FIXME:&nbsp;For&nbsp;now,&nbsp;only&nbsp;allow&nbsp;exact&nbsp;aligned&nbsp;access.&nbsp;*/<br>
&nbsp;&nbsp;if&nbsp;addr&nbsp;==&nbsp;MSIP_BASE&nbsp;&&nbsp;('n&nbsp;==&nbsp;8&nbsp;|&nbsp;'n&nbsp;==&nbsp;4)<br>
&nbsp;&nbsp;then&nbsp;<span style="background-color: hsl(0, 85%, 75%)">{<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;&nbsp;&nbsp;get_config_print_platform()<br>
&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;<span style="background-color: hsl(0, 85%, 70%)">print_platform(&quot;clint[&quot;&nbsp;^&nbsp;BitStr(addr)&nbsp;^&nbsp;&quot;]&nbsp;-&gt;&nbsp;&quot;&nbsp;^&nbsp;BitStr(mip.MSI()))</span><span style="background-color: hsl(0, 85%, 75%)">&#171;Invisible branch not taken here&#187</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;MemValue(sail_zero_extend(mip.MSI(),&nbsp;sizeof(8&nbsp;*&nbsp;'n)))<br>
&nbsp;&nbsp;}</span><br>
&nbsp;&nbsp;else&nbsp;<span style="background-color: hsl(0, 85%, 75%)">if&nbsp;addr&nbsp;==&nbsp;MTIMECMP_BASE&nbsp;&&nbsp;('n&nbsp;==&nbsp;4)<br>
&nbsp;&nbsp;then&nbsp;<span style="background-color: hsl(0, 85%, 70%)">{<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;&nbsp;&nbsp;get_config_print_platform()<br>
&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;<span style="background-color: hsl(0, 85%, 65%)">print_platform(&quot;clint&lt;4&gt;[&quot;&nbsp;^&nbsp;BitStr(addr)&nbsp;^&nbsp;&quot;]&nbsp;-&gt;&nbsp;&quot;&nbsp;^&nbsp;BitStr(mtimecmp[31..0]))</span><span style="background-color: hsl(0, 85%, 70%)">&#171;Invisible branch not taken here&#187</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;FIXME:&nbsp;Redundant&nbsp;zero_extend&nbsp;currently&nbsp;required&nbsp;by&nbsp;Lem&nbsp;backend&nbsp;*/<br>
&nbsp;&nbsp;&nbsp;&nbsp;MemValue(sail_zero_extend(mtimecmp[31..0],&nbsp;32))<br>
&nbsp;&nbsp;}</span><br>
&nbsp;&nbsp;else&nbsp;<span style="background-color: hsl(0, 85%, 70%)">if&nbsp;addr&nbsp;==&nbsp;MTIMECMP_BASE&nbsp;&&nbsp;('n&nbsp;==&nbsp;8)<br>
&nbsp;&nbsp;then&nbsp;<span style="background-color: hsl(0, 85%, 65%)">{<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;&nbsp;&nbsp;get_config_print_platform()<br>
&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;<span style="background-color: hsl(0, 85%, 60%)">print_platform(&quot;clint&lt;8&gt;[&quot;&nbsp;^&nbsp;BitStr(addr)&nbsp;^&nbsp;&quot;]&nbsp;-&gt;&nbsp;&quot;&nbsp;^&nbsp;BitStr(mtimecmp))</span><span style="background-color: hsl(0, 85%, 65%)">&#171;Invisible branch not taken here&#187</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;FIXME:&nbsp;Redundant&nbsp;zero_extend&nbsp;currently&nbsp;required&nbsp;by&nbsp;Lem&nbsp;backend&nbsp;*/<br>
&nbsp;&nbsp;&nbsp;&nbsp;MemValue(sail_zero_extend(mtimecmp,&nbsp;64))<br>
&nbsp;&nbsp;}</span><br>
&nbsp;&nbsp;else&nbsp;<span style="background-color: hsl(0, 85%, 65%)">if&nbsp;addr&nbsp;==&nbsp;MTIMECMP_BASE_HI&nbsp;&&nbsp;('n&nbsp;==&nbsp;4)<br>
&nbsp;&nbsp;then&nbsp;<span style="background-color: hsl(0, 85%, 60%)">{<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;&nbsp;&nbsp;get_config_print_platform()<br>
&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;<span style="background-color: hsl(0, 85%, 55%)">print_platform(&quot;clint-hi&lt;4&gt;[&quot;&nbsp;^&nbsp;BitStr(addr)&nbsp;^&nbsp;&quot;]&nbsp;-&gt;&nbsp;&quot;&nbsp;^&nbsp;BitStr(mtimecmp[63..32]))</span><span style="background-color: hsl(0, 85%, 60%)">&#171;Invisible branch not taken here&#187</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;FIXME:&nbsp;Redundant&nbsp;zero_extend&nbsp;currently&nbsp;required&nbsp;by&nbsp;Lem&nbsp;backend&nbsp;*/<br>
&nbsp;&nbsp;&nbsp;&nbsp;MemValue(sail_zero_extend(mtimecmp[63..32],&nbsp;32))<br>
&nbsp;&nbsp;}</span><br>
&nbsp;&nbsp;else&nbsp;<span style="background-color: hsl(0, 85%, 60%)">if&nbsp;addr&nbsp;==&nbsp;MTIME_BASE&nbsp;&&nbsp;('n&nbsp;==&nbsp;4)<br>
&nbsp;&nbsp;then&nbsp;<span style="background-color: hsl(0, 85%, 55%)">{<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;&nbsp;&nbsp;get_config_print_platform()<br>
&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;<span style="background-color: hsl(0, 85%, 50%)">print_platform(&quot;clint[&quot;&nbsp;^&nbsp;BitStr(addr)&nbsp;^&nbsp;&quot;]&nbsp;-&gt;&nbsp;&quot;&nbsp;^&nbsp;BitStr(mtime))</span><span style="background-color: hsl(0, 85%, 55%)">&#171;Invisible branch not taken here&#187</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;MemValue(sail_zero_extend(mtime[31..0],&nbsp;32))<br>
&nbsp;&nbsp;}</span><br>
&nbsp;&nbsp;else&nbsp;<span style="background-color: hsl(0, 85%, 55%)">if&nbsp;addr&nbsp;==&nbsp;MTIME_BASE&nbsp;&&nbsp;('n&nbsp;==&nbsp;8)<br>
&nbsp;&nbsp;then&nbsp;<span style="background-color: hsl(0, 85%, 50%)">{<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;&nbsp;&nbsp;get_config_print_platform()<br>
&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;<span style="background-color: hsl(0, 85%, 45%)">print_platform(&quot;clint[&quot;&nbsp;^&nbsp;BitStr(addr)&nbsp;^&nbsp;&quot;]&nbsp;-&gt;&nbsp;&quot;&nbsp;^&nbsp;BitStr(mtime))</span><span style="background-color: hsl(0, 85%, 50%)">&#171;Invisible branch not taken here&#187</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;MemValue(sail_zero_extend(mtime,&nbsp;64))<br>
&nbsp;&nbsp;}</span><br>
&nbsp;&nbsp;else&nbsp;<span style="background-color: hsl(0, 85%, 50%)">if&nbsp;addr&nbsp;==&nbsp;MTIME_BASE_HI&nbsp;&&nbsp;('n&nbsp;==&nbsp;4)<br>
&nbsp;&nbsp;then&nbsp;<span style="background-color: hsl(0, 85%, 45%)">{<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;&nbsp;&nbsp;get_config_print_platform()<br>
&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;<span style="background-color: hsl(0, 85%, 40%)">print_platform(&quot;clint[&quot;&nbsp;^&nbsp;BitStr(addr)&nbsp;^&nbsp;&quot;]&nbsp;-&gt;&nbsp;&quot;&nbsp;^&nbsp;BitStr(mtime))</span><span style="background-color: hsl(0, 85%, 45%)">&#171;Invisible branch not taken here&#187</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;MemValue(sail_zero_extend(mtime[63..32],&nbsp;32))<br>
&nbsp;&nbsp;}</span><br>
&nbsp;&nbsp;else&nbsp;<span style="background-color: hsl(0, 85%, 45%)">{<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;&nbsp;&nbsp;get_config_print_platform()<br>
&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;<span style="background-color: hsl(0, 85%, 40%)">print_platform(&quot;clint[&quot;&nbsp;^&nbsp;BitStr(addr)&nbsp;^&nbsp;&quot;]&nbsp;-&gt;&nbsp;&lt;not-mapped&gt;&quot;)</span><span style="background-color: hsl(0, 85%, 45%)">&#171;Invisible branch not taken here&#187</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;match&nbsp;t&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Execute()&nbsp;&nbsp;=&gt;&nbsp;<span style="background-color: hsl(0, 85%, 40%)">MemException(E_Fetch_Access_Fault())</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Read(Data)&nbsp;=&gt;&nbsp;<span style="background-color: hsl(0, 85%, 40%)">MemException(E_Load_Access_Fault())</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt;&nbsp;<span style="background-color: hsl(0, 85%, 40%)">MemException(E_SAMO_Access_Fault())</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;}</span></span></span></span></span></span></span><br>
}</span><br>
<br>
function&nbsp;clint_dispatch()&nbsp;-&gt;&nbsp;unit&nbsp;=&nbsp;<span style="background-color: hsl(120, 85%, 80%)">{<br>
&nbsp;&nbsp;if&nbsp;&nbsp;&nbsp;get_config_print_platform()<br>
&nbsp;&nbsp;then&nbsp;<span style="background-color: hsl(120, 85%, 75%)">print_platform(&quot;clint::tick&nbsp;mtime&nbsp;&lt;-&nbsp;&quot;&nbsp;^&nbsp;BitStr(mtime))</span><span style="background-color: hsl(0, 85%, 80%)">&#171;Invisible branch not taken here&#187</span>;<br>
&nbsp;&nbsp;mip-&gt;MTI()&nbsp;=&nbsp;0b0;<br>
&nbsp;&nbsp;if&nbsp;mtimecmp&nbsp;&lt;=_u&nbsp;mtime&nbsp;then&nbsp;<span style="background-color: hsl(120, 85%, 75%)">{<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;&nbsp;&nbsp;get_config_print_platform()<br>
&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;<span style="background-color: hsl(120, 85%, 70%)">print_platform(&quot;&nbsp;clint&nbsp;timer&nbsp;pending&nbsp;at&nbsp;mtime&nbsp;&quot;&nbsp;^&nbsp;BitStr(mtime))</span><span style="background-color: hsl(0, 85%, 80%)">&#171;Invisible branch not taken here&#187</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;mip-&gt;MTI()&nbsp;=&nbsp;0b1<br>
&nbsp;&nbsp;}</span><span style="background-color: hsl(0, 85%, 80%)">&#171;Invisible branch not taken here&#187</span><br>
}</span><br>
<br>
/*&nbsp;The&nbsp;rreg&nbsp;effect&nbsp;is&nbsp;due&nbsp;to&nbsp;checking&nbsp;mtime.&nbsp;*/<br>
val&nbsp;clint_store:&nbsp;forall&nbsp;'n,&nbsp;'n&nbsp;&gt;&nbsp;0.&nbsp;(xlenbits,&nbsp;int('n),&nbsp;bits(8&nbsp;*&nbsp;'n))&nbsp;-&gt;&nbsp;MemoryOpResult(bool)&nbsp;effect&nbsp;{rreg,wreg}<br>
function&nbsp;clint_store(addr,&nbsp;width,&nbsp;data)&nbsp;=&nbsp;<span style="background-color: hsl(0, 85%, 80%)">{<br>
&nbsp;&nbsp;let&nbsp;addr&nbsp;=&nbsp;addr&nbsp;-&nbsp;plat_clint_base&nbsp;();<br>
&nbsp;&nbsp;if&nbsp;addr&nbsp;==&nbsp;MSIP_BASE&nbsp;&&nbsp;('n&nbsp;==&nbsp;8&nbsp;|&nbsp;'n&nbsp;==&nbsp;4)&nbsp;then&nbsp;<span style="background-color: hsl(0, 85%, 75%)">{<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;&nbsp;&nbsp;get_config_print_platform()<br>
&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;<span style="background-color: hsl(0, 85%, 70%)">print_platform(&quot;clint[&quot;&nbsp;^&nbsp;BitStr(addr)&nbsp;^&nbsp;&quot;]&nbsp;&lt;-&nbsp;&quot;&nbsp;^&nbsp;BitStr(data)&nbsp;^&nbsp;&quot;&nbsp;(mip.MSI&nbsp;&lt;-&nbsp;&quot;&nbsp;^&nbsp;BitStr(data[0])&nbsp;^&nbsp;&quot;)&quot;)</span><span style="background-color: hsl(0, 85%, 75%)">&#171;Invisible branch not taken here&#187</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;mip-&gt;MSI()&nbsp;=&nbsp;[data[0]];<br>
&nbsp;&nbsp;&nbsp;&nbsp;clint_dispatch();<br>
&nbsp;&nbsp;&nbsp;&nbsp;MemValue(true)<br>
&nbsp;&nbsp;}</span>&nbsp;else&nbsp;<span style="background-color: hsl(0, 85%, 75%)">if&nbsp;addr&nbsp;==&nbsp;MTIMECMP_BASE&nbsp;&&nbsp;'n&nbsp;==&nbsp;8&nbsp;then&nbsp;<span style="background-color: hsl(0, 85%, 70%)">{<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;&nbsp;&nbsp;get_config_print_platform()<br>
&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;<span style="background-color: hsl(0, 85%, 65%)">print_platform(&quot;clint&lt;8&gt;[&quot;&nbsp;^&nbsp;BitStr(addr)&nbsp;^&nbsp;&quot;]&nbsp;&lt;-&nbsp;&quot;&nbsp;^&nbsp;BitStr(data)&nbsp;^&nbsp;&quot;&nbsp;(mtimecmp)&quot;)</span><span style="background-color: hsl(0, 85%, 70%)">&#171;Invisible branch not taken here&#187</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;mtimecmp&nbsp;=&nbsp;sail_zero_extend(data,&nbsp;64);&nbsp;/*&nbsp;FIXME:&nbsp;Redundant&nbsp;zero_extend&nbsp;currently&nbsp;required&nbsp;by&nbsp;Lem&nbsp;backend&nbsp;*/<br>
&nbsp;&nbsp;&nbsp;&nbsp;clint_dispatch();<br>
&nbsp;&nbsp;&nbsp;&nbsp;MemValue(true)<br>
&nbsp;&nbsp;}</span>&nbsp;else&nbsp;<span style="background-color: hsl(0, 85%, 70%)">if&nbsp;addr&nbsp;==&nbsp;MTIMECMP_BASE&nbsp;&&nbsp;'n&nbsp;==&nbsp;4&nbsp;then&nbsp;<span style="background-color: hsl(0, 85%, 65%)">{<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;&nbsp;&nbsp;get_config_print_platform()<br>
&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;<span style="background-color: hsl(0, 85%, 60%)">print_platform(&quot;clint&lt;4&gt;[&quot;&nbsp;^&nbsp;BitStr(addr)&nbsp;^&nbsp;&quot;]&nbsp;&lt;-&nbsp;&quot;&nbsp;^&nbsp;BitStr(data)&nbsp;^&nbsp;&quot;&nbsp;(mtimecmp)&quot;)</span><span style="background-color: hsl(0, 85%, 65%)">&#171;Invisible branch not taken here&#187</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;mtimecmp&nbsp;=&nbsp;vector_update_subrange(mtimecmp,&nbsp;31,&nbsp;0,&nbsp;sail_zero_extend(data,&nbsp;32));&nbsp;&nbsp;/*&nbsp;FIXME:&nbsp;Redundant&nbsp;zero_extend&nbsp;currently&nbsp;required&nbsp;by&nbsp;Lem&nbsp;backend&nbsp;*/<br>
&nbsp;&nbsp;&nbsp;&nbsp;clint_dispatch();<br>
&nbsp;&nbsp;&nbsp;&nbsp;MemValue(true)<br>
&nbsp;&nbsp;}</span>&nbsp;else&nbsp;<span style="background-color: hsl(0, 85%, 65%)">if&nbsp;addr&nbsp;==&nbsp;MTIMECMP_BASE_HI&nbsp;&&nbsp;'n&nbsp;==&nbsp;4&nbsp;then&nbsp;<span style="background-color: hsl(0, 85%, 60%)">{<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;&nbsp;&nbsp;get_config_print_platform()<br>
&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;<span style="background-color: hsl(0, 85%, 55%)">print_platform(&quot;clint&lt;4&gt;[&quot;&nbsp;^&nbsp;BitStr(addr)&nbsp;^&nbsp;&quot;]&nbsp;&lt;-&nbsp;&quot;&nbsp;^&nbsp;BitStr(data)&nbsp;^&nbsp;&quot;&nbsp;(mtimecmp)&quot;)</span><span style="background-color: hsl(0, 85%, 60%)">&#171;Invisible branch not taken here&#187</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;mtimecmp&nbsp;=&nbsp;vector_update_subrange(mtimecmp,&nbsp;63,&nbsp;32,&nbsp;sail_zero_extend(data,&nbsp;32));&nbsp;/*&nbsp;FIXME:&nbsp;Redundant&nbsp;zero_extend&nbsp;currently&nbsp;required&nbsp;by&nbsp;Lem&nbsp;backend&nbsp;*/<br>
&nbsp;&nbsp;&nbsp;&nbsp;clint_dispatch();<br>
&nbsp;&nbsp;&nbsp;&nbsp;MemValue(true)<br>
&nbsp;&nbsp;}</span>&nbsp;else&nbsp;<span style="background-color: hsl(0, 85%, 60%)">{<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;&nbsp;&nbsp;get_config_print_platform()<br>
&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;<span style="background-color: hsl(0, 85%, 55%)">print_platform(&quot;clint[&quot;&nbsp;^&nbsp;BitStr(addr)&nbsp;^&nbsp;&quot;]&nbsp;&lt;-&nbsp;&quot;&nbsp;^&nbsp;BitStr(data)&nbsp;^&nbsp;&quot;&nbsp;(&lt;unmapped&gt;)&quot;)</span><span style="background-color: hsl(0, 85%, 60%)">&#171;Invisible branch not taken here&#187</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;MemException(E_SAMO_Access_Fault())<br>
&nbsp;&nbsp;}</span></span></span></span><br>
}</span><br>
<br>
val&nbsp;tick_clock&nbsp;:&nbsp;unit&nbsp;-&gt;&nbsp;unit&nbsp;effect&nbsp;{rreg,&nbsp;wreg}<br>
function&nbsp;tick_clock()&nbsp;=&nbsp;<span style="background-color: hsl(120, 85%, 80%)">{<br>
&nbsp;&nbsp;if&nbsp;&nbsp;&nbsp;mcountinhibit.CY()&nbsp;==&nbsp;0b0<br>
&nbsp;&nbsp;then&nbsp;<span style="background-color: hsl(120, 85%, 75%)">mcycle&nbsp;=&nbsp;mcycle&nbsp;+&nbsp;1</span><span style="background-color: hsl(0, 85%, 80%)">&#171;Invisible branch not taken here&#187</span>;<br>
<br>
&nbsp;&nbsp;mtime&nbsp;&nbsp;=&nbsp;mtime&nbsp;&nbsp;+&nbsp;1;<br>
&nbsp;&nbsp;clint_dispatch()<br>
}</span><br>
<br>
/*&nbsp;Basic&nbsp;terminal&nbsp;character&nbsp;I/O.&nbsp;*/<br>
<br>
val&nbsp;plat_term_write&nbsp;=&nbsp;{ocaml:&nbsp;&quot;Platform.term_write&quot;,&nbsp;c:&nbsp;&quot;plat_term_write&quot;,&nbsp;lem:&nbsp;&quot;plat_term_write&quot;}&nbsp;:&nbsp;bits(8)&nbsp;-&gt;&nbsp;unit<br>
val&nbsp;plat_term_read&nbsp;&nbsp;=&nbsp;{ocaml:&nbsp;&quot;Platform.term_read&quot;,&nbsp;&nbsp;c:&nbsp;&quot;plat_term_read&quot;,&nbsp;lem:&nbsp;&quot;plat_term_read&quot;}&nbsp;&nbsp;:&nbsp;unit&nbsp;-&gt;&nbsp;bits(8)<br>
<br>
/*&nbsp;Spike's&nbsp;HTIF&nbsp;device&nbsp;interface,&nbsp;which&nbsp;multiplexes&nbsp;the&nbsp;above&nbsp;MMIO&nbsp;devices.&nbsp;*/<br>
<br>
bitfield&nbsp;htif_cmd&nbsp;:&nbsp;bits(64)&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;device&nbsp;&nbsp;:&nbsp;63&nbsp;..&nbsp;56,<br>
&nbsp;&nbsp;cmd&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;55&nbsp;..&nbsp;48,<br>
&nbsp;&nbsp;payload&nbsp;:&nbsp;47&nbsp;..&nbsp;0<br>
}<br>
<br>
register&nbsp;htif_tohost&nbsp;:&nbsp;bits(64)<br>
register&nbsp;htif_done&nbsp;&nbsp;&nbsp;:&nbsp;bool<br>
register&nbsp;htif_exit_code&nbsp;:&nbsp;bits(64)<br>
<br>
<br>
/*&nbsp;Since&nbsp;the&nbsp;htif&nbsp;tohost&nbsp;port&nbsp;is&nbsp;only&nbsp;available&nbsp;at&nbsp;a&nbsp;single&nbsp;address,<br>
&nbsp;*&nbsp;we'll&nbsp;assume&nbsp;here&nbsp;that&nbsp;physical&nbsp;memory&nbsp;model&nbsp;has&nbsp;correctly<br>
&nbsp;*&nbsp;dispatched&nbsp;the&nbsp;address.<br>
&nbsp;*/<br>
<br>
val&nbsp;htif_load&nbsp;:&nbsp;forall&nbsp;'n,&nbsp;'n&nbsp;&gt;&nbsp;0.&nbsp;(AccessType(ext_access_type),&nbsp;xlenbits,&nbsp;int('n))&nbsp;-&gt;&nbsp;MemoryOpResult(bits(8&nbsp;*&nbsp;'n))&nbsp;effect&nbsp;{rreg}<br>
function&nbsp;htif_load(t,&nbsp;paddr,&nbsp;width)&nbsp;=&nbsp;<span style="background-color: hsl(120, 85%, 80%)">{<br>
&nbsp;&nbsp;if&nbsp;&nbsp;&nbsp;get_config_print_platform()<br>
&nbsp;&nbsp;then&nbsp;<span style="background-color: hsl(120, 85%, 75%)">print_platform(&quot;htif[&quot;&nbsp;^&nbsp;BitStr(paddr)&nbsp;^&nbsp;&quot;]&nbsp;-&gt;&nbsp;&quot;&nbsp;^&nbsp;BitStr(htif_tohost))</span><span style="background-color: hsl(0, 85%, 80%)">&#171;Invisible branch not taken here&#187</span>;<br>
&nbsp;&nbsp;/*&nbsp;FIXME:&nbsp;For&nbsp;now,&nbsp;only&nbsp;allow&nbsp;the&nbsp;expected&nbsp;access&nbsp;widths.&nbsp;*/<br>
&nbsp;&nbsp;if&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;width&nbsp;==&nbsp;8&nbsp;&&nbsp;(paddr&nbsp;==&nbsp;plat_htif_tohost())<br>
&nbsp;&nbsp;then&nbsp;&nbsp;&nbsp;&nbsp;<span style="background-color: hsl(120, 85%, 75%)">MemValue(sail_zero_extend(htif_tohost,&nbsp;64))</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;FIXME:&nbsp;Redundant&nbsp;zero_extend&nbsp;currently&nbsp;required&nbsp;by&nbsp;Lem&nbsp;backend&nbsp;*/<br>
&nbsp;&nbsp;else&nbsp;<span style="background-color: hsl(0, 85%, 80%)">if&nbsp;width&nbsp;==&nbsp;4&nbsp;&&nbsp;paddr&nbsp;==&nbsp;plat_htif_tohost()<br>
&nbsp;&nbsp;then&nbsp;&nbsp;&nbsp;&nbsp;<span style="background-color: hsl(0, 85%, 75%)">MemValue(sail_zero_extend(htif_tohost[31..0],&nbsp;32))</span>&nbsp;&nbsp;/*&nbsp;FIXME:&nbsp;Redundant&nbsp;zero_extend&nbsp;currently&nbsp;required&nbsp;by&nbsp;Lem&nbsp;backend&nbsp;*/<br>
&nbsp;&nbsp;else&nbsp;<span style="background-color: hsl(0, 85%, 75%)">if&nbsp;width&nbsp;==&nbsp;4&nbsp;&&nbsp;paddr&nbsp;==&nbsp;plat_htif_tohost()&nbsp;+&nbsp;4<br>
&nbsp;&nbsp;then&nbsp;&nbsp;&nbsp;&nbsp;<span style="background-color: hsl(0, 85%, 70%)">MemValue(sail_zero_extend(htif_tohost[63..32],&nbsp;32))</span>&nbsp;/*&nbsp;FIXME:&nbsp;Redundant&nbsp;zero_extend&nbsp;currently&nbsp;required&nbsp;by&nbsp;Lem&nbsp;backend&nbsp;*/<br>
&nbsp;&nbsp;else&nbsp;<span style="background-color: hsl(0, 85%, 70%)">match&nbsp;t&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;Execute()&nbsp;&nbsp;=&gt;&nbsp;<span style="background-color: hsl(0, 85%, 65%)">MemException(E_Fetch_Access_Fault())</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;Read(Data)&nbsp;=&gt;&nbsp;<span style="background-color: hsl(0, 85%, 65%)">MemException(E_Load_Access_Fault())</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;_&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt;&nbsp;<span style="background-color: hsl(0, 85%, 65%)">MemException(E_SAMO_Access_Fault())</span><br>
&nbsp;&nbsp;}</span></span></span><br>
}</span><br>
<br>
/*&nbsp;The&nbsp;rreg,wreg&nbsp;effects&nbsp;are&nbsp;an&nbsp;artifact&nbsp;of&nbsp;using&nbsp;'register'&nbsp;to&nbsp;implement&nbsp;device&nbsp;state.&nbsp;*/<br>
val&nbsp;htif_store:&nbsp;forall&nbsp;'n,&nbsp;0&nbsp;&lt;&nbsp;'n&nbsp;&lt;=&nbsp;8.&nbsp;(xlenbits,&nbsp;int('n),&nbsp;bits(8&nbsp;*&nbsp;'n))&nbsp;-&gt;&nbsp;MemoryOpResult(bool)&nbsp;effect&nbsp;{rreg,wreg}<br>
function&nbsp;htif_store(paddr,&nbsp;width,&nbsp;data)&nbsp;=&nbsp;<span style="background-color: hsl(120, 85%, 80%)">{<br>
&nbsp;&nbsp;if&nbsp;&nbsp;&nbsp;get_config_print_platform()<br>
&nbsp;&nbsp;then&nbsp;<span style="background-color: hsl(120, 85%, 75%)">print_platform(&quot;htif[&quot;&nbsp;^&nbsp;BitStr(paddr)&nbsp;^&nbsp;&quot;]&nbsp;&lt;-&nbsp;&quot;&nbsp;^&nbsp;BitStr(data))</span><span style="background-color: hsl(0, 85%, 80%)">&#171;Invisible branch not taken here&#187</span>;<br>
&nbsp;&nbsp;/*&nbsp;Store&nbsp;the&nbsp;written&nbsp;value&nbsp;so&nbsp;that&nbsp;we&nbsp;can&nbsp;ack&nbsp;it&nbsp;later.&nbsp;*/<br>
&nbsp;&nbsp;if&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;width&nbsp;==&nbsp;8<br>
&nbsp;&nbsp;then&nbsp;&nbsp;&nbsp;&nbsp;<span style="background-color: hsl(120, 85%, 75%)">{&nbsp;htif_tohost&nbsp;=&nbsp;EXTZ(data)&nbsp;}</span><br>
&nbsp;&nbsp;else&nbsp;<span style="background-color: hsl(120, 85%, 75%)">if&nbsp;width&nbsp;==&nbsp;4&nbsp;&&nbsp;paddr&nbsp;==&nbsp;plat_htif_tohost()<br>
&nbsp;&nbsp;then&nbsp;&nbsp;&nbsp;&nbsp;<span style="background-color: hsl(120, 85%, 70%)">{&nbsp;htif_tohost&nbsp;=&nbsp;vector_update_subrange(htif_tohost,&nbsp;31,&nbsp;0,&nbsp;data)&nbsp;}</span><br>
&nbsp;&nbsp;else&nbsp;<span style="background-color: hsl(0, 85%, 80%)">if&nbsp;width&nbsp;==&nbsp;4&nbsp;&&nbsp;paddr&nbsp;==&nbsp;plat_htif_tohost()&nbsp;+&nbsp;4<br>
&nbsp;&nbsp;then&nbsp;&nbsp;&nbsp;&nbsp;<span style="background-color: hsl(0, 85%, 75%)">{&nbsp;htif_tohost&nbsp;=&nbsp;vector_update_subrange(htif_tohost,&nbsp;63,&nbsp;32,&nbsp;data)&nbsp;}</span><br>
&nbsp;&nbsp;else&nbsp;&nbsp;&nbsp;&nbsp;<span style="background-color: hsl(0, 85%, 75%)">{&nbsp;htif_tohost&nbsp;=&nbsp;EXTZ(data)&nbsp;}</span></span></span>;<br>
<br>
&nbsp;&nbsp;/*&nbsp;Process&nbsp;the&nbsp;cmd&nbsp;immediately;&nbsp;this&nbsp;is&nbsp;needed&nbsp;for&nbsp;terminal&nbsp;output.&nbsp;*/<br>
&nbsp;&nbsp;let&nbsp;cmd&nbsp;=&nbsp;Mk_htif_cmd(htif_tohost);<br>
&nbsp;&nbsp;match&nbsp;cmd.device()&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;0x00&nbsp;=&gt;&nbsp;<span style="background-color: hsl(120, 85%, 75%)">{&nbsp;/*&nbsp;syscall-proxy&nbsp;*/<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;&nbsp;&nbsp;get_config_print_platform()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;<span style="background-color: hsl(120, 85%, 70%)">print_platform(&quot;htif-syscall-proxy&nbsp;cmd:&nbsp;&quot;&nbsp;^&nbsp;BitStr(cmd.payload()))</span><span style="background-color: hsl(0, 85%, 80%)">&#171;Invisible branch not taken here&#187</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;&nbsp;&nbsp;cmd.payload()[0]&nbsp;==&nbsp;bitone<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;<span style="background-color: hsl(120, 85%, 70%)">{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;htif_done&nbsp;=&nbsp;true;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;htif_exit_code&nbsp;=&nbsp;(sail_zero_extend(cmd.payload(),&nbsp;64)&nbsp;&gt;&gt;&nbsp;1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;<span style="background-color: hsl(0, 85%, 80%)">()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;}</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;0x01&nbsp;=&gt;&nbsp;<span style="background-color: hsl(0, 85%, 80%)">{&nbsp;/*&nbsp;terminal&nbsp;*/<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;&nbsp;&nbsp;get_config_print_platform()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;<span style="background-color: hsl(0, 85%, 75%)">print_platform(&quot;htif-term&nbsp;cmd:&nbsp;&quot;&nbsp;^&nbsp;BitStr(cmd.payload()))</span><span style="background-color: hsl(0, 85%, 80%)">&#171;Invisible branch not taken here&#187</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;match&nbsp;cmd.cmd()&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x00&nbsp;=&gt;&nbsp;/*&nbsp;TODO:&nbsp;terminal&nbsp;input&nbsp;handling&nbsp;*/&nbsp;<span style="background-color: hsl(0, 85%, 75%)">()</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x01&nbsp;=&gt;&nbsp;<span style="background-color: hsl(0, 85%, 75%)">plat_term_write(cmd.payload()[7..0])</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c&nbsp;&nbsp;&nbsp;&nbsp;=&gt;&nbsp;<span style="background-color: hsl(0, 85%, 75%)">print(&quot;Unknown&nbsp;term&nbsp;cmd:&nbsp;&quot;&nbsp;^&nbsp;BitStr(c))</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;}</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;d&nbsp;=&gt;&nbsp;<span style="background-color: hsl(0, 85%, 80%)">print(&quot;htif-????&nbsp;cmd:&nbsp;&quot;&nbsp;^&nbsp;BitStr(data))</span><br>
&nbsp;&nbsp;};<br>
&nbsp;&nbsp;MemValue(true)<br>
}</span><br>
<br>
val&nbsp;htif_tick&nbsp;:&nbsp;unit&nbsp;-&gt;&nbsp;unit&nbsp;effect&nbsp;{rreg,&nbsp;wreg}<br>
function&nbsp;htif_tick()&nbsp;=&nbsp;<span style="background-color: hsl(120, 85%, 80%)">{<br>
&nbsp;&nbsp;if&nbsp;&nbsp;&nbsp;get_config_print_platform()<br>
&nbsp;&nbsp;then&nbsp;<span style="background-color: hsl(120, 85%, 75%)">print_platform(&quot;htif::tick&nbsp;&quot;&nbsp;^&nbsp;BitStr(htif_tohost))</span><span style="background-color: hsl(0, 85%, 80%)">&#171;Invisible branch not taken here&#187</span>;<br>
&nbsp;&nbsp;htif_tohost&nbsp;=&nbsp;EXTZ(0b0)&nbsp;&nbsp;/*&nbsp;htif&nbsp;ack&nbsp;*/<br>
}</span><br>
<br>
/*&nbsp;Top-level&nbsp;MMIO&nbsp;dispatch&nbsp;*/<br>
$ifndef&nbsp;RVFI_DII<br>
function&nbsp;within_mmio_readable&nbsp;forall&nbsp;'n,&nbsp;0&nbsp;&lt;&nbsp;'n&nbsp;&lt;=&nbsp;max_mem_access&nbsp;.&nbsp;(addr&nbsp;:&nbsp;xlenbits,&nbsp;width&nbsp;:&nbsp;atom('n))&nbsp;-&gt;&nbsp;bool&nbsp;=<br>
&nbsp;&nbsp;<span style="background-color: hsl(120, 85%, 80%)">within_clint(addr,&nbsp;width)&nbsp;|&nbsp;(within_htif_readable(addr,&nbsp;width)&nbsp;&&nbsp;1&nbsp;&lt;=&nbsp;'n)</span><br>
$else<br>
function&nbsp;within_mmio_readable&nbsp;forall&nbsp;'n,&nbsp;0&nbsp;&lt;&nbsp;'n&nbsp;&lt;=&nbsp;max_mem_access&nbsp;.&nbsp;(addr&nbsp;:&nbsp;xlenbits,&nbsp;width&nbsp;:&nbsp;atom('n))&nbsp;-&gt;&nbsp;bool&nbsp;=&nbsp;false<br>
$endif<br>
<br>
$ifndef&nbsp;RVFI_DII<br>
function&nbsp;within_mmio_writable&nbsp;forall&nbsp;'n,&nbsp;0&nbsp;&lt;&nbsp;'n&nbsp;&lt;=&nbsp;max_mem_access&nbsp;.&nbsp;(addr&nbsp;:&nbsp;xlenbits,&nbsp;width&nbsp;:&nbsp;atom('n))&nbsp;-&gt;&nbsp;bool&nbsp;=<br>
&nbsp;&nbsp;<span style="background-color: hsl(120, 85%, 80%)">within_clint(addr,&nbsp;width)&nbsp;|&nbsp;(within_htif_writable(addr,&nbsp;width)&nbsp;&&nbsp;'n&nbsp;&lt;=&nbsp;8)</span><br>
$else<br>
function&nbsp;within_mmio_writable&nbsp;forall&nbsp;'n,&nbsp;0&nbsp;&lt;&nbsp;'n&nbsp;&lt;=&nbsp;max_mem_access&nbsp;.&nbsp;(addr&nbsp;:&nbsp;xlenbits,&nbsp;width&nbsp;:&nbsp;atom('n))&nbsp;-&gt;&nbsp;bool&nbsp;=&nbsp;false<br>
$endif<br>
<br>
function&nbsp;mmio_read&nbsp;forall&nbsp;'n,&nbsp;0&nbsp;&lt;&nbsp;'n&nbsp;&lt;=&nbsp;max_mem_access&nbsp;.&nbsp;(t&nbsp;:&nbsp;AccessType(ext_access_type),&nbsp;paddr&nbsp;:&nbsp;xlenbits,&nbsp;width&nbsp;:&nbsp;atom('n))&nbsp;-&gt;&nbsp;MemoryOpResult(bits(8&nbsp;*&nbsp;'n))&nbsp;=<br>
&nbsp;&nbsp;<span style="background-color: hsl(120, 85%, 80%)">if&nbsp;&nbsp;&nbsp;within_clint(paddr,&nbsp;width)<br>
&nbsp;&nbsp;then&nbsp;<span style="background-color: hsl(0, 85%, 80%)">clint_load(t,&nbsp;paddr,&nbsp;width)</span><br>
&nbsp;&nbsp;else&nbsp;<span style="background-color: hsl(120, 85%, 75%)">if&nbsp;within_htif_readable(paddr,&nbsp;width)&nbsp;&&nbsp;(1&nbsp;&lt;=&nbsp;'n)<br>
&nbsp;&nbsp;then&nbsp;<span style="background-color: hsl(120, 85%, 70%)">htif_load(t,&nbsp;paddr,&nbsp;width)</span><br>
&nbsp;&nbsp;else&nbsp;<span style="background-color: hsl(0, 85%, 80%)">match&nbsp;t&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;Execute()&nbsp;&nbsp;=&gt;&nbsp;<span style="background-color: hsl(0, 85%, 75%)">MemException(E_Fetch_Access_Fault())</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;Read(Data)&nbsp;=&gt;&nbsp;<span style="background-color: hsl(0, 85%, 75%)">MemException(E_Load_Access_Fault())</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;_&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt;&nbsp;<span style="background-color: hsl(0, 85%, 75%)">MemException(E_SAMO_Access_Fault())</span><br>
&nbsp;&nbsp;}</span></span></span><br>
<br>
function&nbsp;mmio_write&nbsp;forall&nbsp;'n,&nbsp;0&nbsp;&lt;'n&nbsp;&lt;=&nbsp;max_mem_access&nbsp;.&nbsp;(paddr&nbsp;:&nbsp;xlenbits,&nbsp;width&nbsp;:&nbsp;atom('n),&nbsp;data:&nbsp;bits(8&nbsp;*&nbsp;'n))&nbsp;-&gt;&nbsp;MemoryOpResult(bool)&nbsp;=<br>
&nbsp;&nbsp;<span style="background-color: hsl(120, 85%, 80%)">if&nbsp;&nbsp;&nbsp;within_clint(paddr,&nbsp;width)<br>
&nbsp;&nbsp;then&nbsp;<span style="background-color: hsl(0, 85%, 80%)">clint_store(paddr,&nbsp;width,&nbsp;data)</span><br>
&nbsp;&nbsp;else&nbsp;<span style="background-color: hsl(120, 85%, 75%)">if&nbsp;within_htif_writable(paddr,&nbsp;width)&nbsp;&&nbsp;'n&nbsp;&lt;=&nbsp;8<br>
&nbsp;&nbsp;then&nbsp;<span style="background-color: hsl(120, 85%, 70%)">htif_store(paddr,&nbsp;width,&nbsp;data)</span><br>
&nbsp;&nbsp;else&nbsp;<span style="background-color: hsl(0, 85%, 80%)">MemException(E_SAMO_Access_Fault())</span></span></span><br>
<br>
/*&nbsp;Platform&nbsp;initialization&nbsp;and&nbsp;ticking.&nbsp;*/<br>
<br>
function&nbsp;init_platform()&nbsp;-&gt;&nbsp;unit&nbsp;=&nbsp;<span style="background-color: hsl(120, 85%, 80%)">{<br>
&nbsp;&nbsp;htif_tohost&nbsp;=&nbsp;EXTZ(0b0);<br>
&nbsp;&nbsp;htif_done&nbsp;&nbsp;&nbsp;=&nbsp;false;<br>
&nbsp;&nbsp;htif_exit_code&nbsp;=&nbsp;EXTZ(0b0)<br>
}</span><br>
<br>
function&nbsp;tick_platform()&nbsp;-&gt;&nbsp;unit&nbsp;=&nbsp;<span style="background-color: hsl(120, 85%, 80%)">{<br>
&nbsp;&nbsp;htif_tick();<br>
}</span><br>
<br>
/*&nbsp;Platform-specific&nbsp;handling&nbsp;of&nbsp;instruction&nbsp;faults&nbsp;*/<br>
<br>
function&nbsp;handle_illegal()&nbsp;-&gt;&nbsp;unit&nbsp;=&nbsp;<span style="background-color: hsl(120, 85%, 80%)">{<br>
&nbsp;&nbsp;let&nbsp;info&nbsp;=&nbsp;if&nbsp;plat_mtval_has_illegal_inst_bits&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;<span style="background-color: hsl(0, 85%, 80%)">Some(instbits)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;<span style="background-color: hsl(120, 85%, 75%)">None()</span>;<br>
&nbsp;&nbsp;let&nbsp;t&nbsp;:&nbsp;sync_exception&nbsp;=&nbsp;struct&nbsp;{&nbsp;trap&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;E_Illegal_Instr(),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;excinfo&nbsp;=&nbsp;info,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ext&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;None()&nbsp;};<br>
&nbsp;&nbsp;set_next_pc(exception_handler(cur_privilege,&nbsp;CTL_TRAP(t),&nbsp;PC))<br>
}</span><br>
<br>
/*&nbsp;Platform-specific&nbsp;wait-for-interrupt&nbsp;*/<br>
<br>
function&nbsp;platform_wfi()&nbsp;-&gt;&nbsp;unit&nbsp;=&nbsp;<span style="background-color: hsl(120, 85%, 80%)">{<br>
&nbsp;&nbsp;cancel_reservation();<br>
&nbsp;&nbsp;/*&nbsp;speed&nbsp;execution&nbsp;by&nbsp;getting&nbsp;the&nbsp;timer&nbsp;to&nbsp;fire&nbsp;at&nbsp;the&nbsp;next&nbsp;instruction,<br>
&nbsp;&nbsp;&nbsp;*&nbsp;since&nbsp;we&nbsp;currently&nbsp;don't&nbsp;have&nbsp;any&nbsp;other&nbsp;devices&nbsp;raising&nbsp;interrupts.<br>
&nbsp;&nbsp;&nbsp;*/<br>
&nbsp;&nbsp;if&nbsp;mtime&nbsp;&lt;_u&nbsp;mtimecmp&nbsp;then&nbsp;<span style="background-color: hsl(0, 85%, 80%)">{<br>
&nbsp;&nbsp;&nbsp;&nbsp;mtime&nbsp;&nbsp;=&nbsp;mtimecmp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;mcycle&nbsp;=&nbsp;mtimecmp;<br>
&nbsp;&nbsp;}</span><br>
}</span><br>
</code>
</body>
</html>