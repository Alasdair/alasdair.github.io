<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>riscv_duopod</title></head>
<body>
<h1>riscv_duopod.sail (0/0) -</h1>
<code style="display: block">
<br>
$include&nbsp;&quot;prelude.sail&quot;<br>
$include&nbsp;&quot;riscv_xlen64.sail&quot;<br>
<br>
type&nbsp;regbits&nbsp;=&nbsp;bits(5)<br>
<br>
val&nbsp;zeros&nbsp;:&nbsp;forall&nbsp;'n,&nbsp;'n&nbsp;&gt;=&nbsp;0.&nbsp;atom('n)&nbsp;-&gt;&nbsp;bits('n)<br>
function&nbsp;zeros&nbsp;n&nbsp;=&nbsp;replicate_bits(0b0,&nbsp;n)<br>
<br>
/*&nbsp;Architectural&nbsp;state&nbsp;*/<br>
<br>
register&nbsp;PC&nbsp;:&nbsp;xlenbits<br>
register&nbsp;nextPC&nbsp;:&nbsp;xlenbits<br>
<br>
register&nbsp;Xs&nbsp;:&nbsp;vector(32,&nbsp;dec,&nbsp;xlenbits)<br>
<br>
/*&nbsp;Getters&nbsp;and&nbsp;setters&nbsp;for&nbsp;X&nbsp;registers&nbsp;(special&nbsp;case&nbsp;for&nbsp;zeros&nbsp;register,&nbsp;x0)&nbsp;*/<br>
val&nbsp;rX&nbsp;:&nbsp;regbits&nbsp;-&gt;&nbsp;xlenbits&nbsp;effect&nbsp;{rreg}<br>
<br>
function&nbsp;rX(r)&nbsp;=<br>
&nbsp;&nbsp;match&nbsp;r&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;0b00000&nbsp;=&gt;&nbsp;EXTZ(0x0),<br>
&nbsp;&nbsp;&nbsp;&nbsp;_&nbsp;=&gt;&nbsp;Xs[unsigned(r)]<br>
&nbsp;&nbsp;}<br>
<br>
val&nbsp;wX&nbsp;:&nbsp;(regbits,&nbsp;xlenbits)&nbsp;-&gt;&nbsp;unit&nbsp;effect&nbsp;{wreg}<br>
<br>
function&nbsp;wX(r,&nbsp;v)&nbsp;=<br>
&nbsp;&nbsp;if&nbsp;r&nbsp;!=&nbsp;0b00000&nbsp;then&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Xs[unsigned(r)]&nbsp;=&nbsp;v;<br>
&nbsp;&nbsp;}<br>
<br>
overload&nbsp;X&nbsp;=&nbsp;{rX,&nbsp;wX}<br>
<br>
/*&nbsp;Accessors&nbsp;for&nbsp;memory&nbsp;*/<br>
val&nbsp;MEMr&nbsp;=&nbsp;{&nbsp;lem:&nbsp;&quot;MEMr&quot;,&nbsp;coq:&nbsp;&quot;MEMr&quot;,&nbsp;_&nbsp;:&nbsp;&quot;read_ram&quot;&nbsp;}&nbsp;:&nbsp;forall&nbsp;'n&nbsp;'m,&nbsp;'n&nbsp;&gt;=&nbsp;0.<br>
&nbsp;&nbsp;&nbsp;(atom('m),&nbsp;int('n),&nbsp;bits('m),&nbsp;bits('m))&nbsp;-&gt;&nbsp;bits(8&nbsp;*&nbsp;'n)&nbsp;effect&nbsp;{rmem}<br>
<br>
val&nbsp;read_mem&nbsp;:&nbsp;forall&nbsp;'n,&nbsp;'n&nbsp;&gt;=&nbsp;0.&nbsp;(xlenbits,&nbsp;int('n))&nbsp;-&gt;&nbsp;bits(8&nbsp;*&nbsp;'n)&nbsp;effect&nbsp;{rmem}<br>
function&nbsp;read_mem(addr,&nbsp;width)&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;MEMr(sizeof(xlen),&nbsp;width,&nbsp;EXTZ(0x0),&nbsp;addr)<br>
<br>
/*&nbsp;Instruction&nbsp;decode&nbsp;and&nbsp;execute&nbsp;*/<br>
enum&nbsp;iop&nbsp;=&nbsp;{RISCV_ADDI,&nbsp;RISCV_SLTI,&nbsp;RISCV_SLTIU,&nbsp;RISCV_XORI,&nbsp;RISCV_ORI,&nbsp;RISCV_ANDI}<br>
scattered&nbsp;union&nbsp;ast<br>
<br>
val&nbsp;decode&nbsp;:&nbsp;bits(32)&nbsp;-&gt;&nbsp;option(ast)&nbsp;effect&nbsp;pure<br>
<br>
val&nbsp;execute&nbsp;:&nbsp;ast&nbsp;-&gt;&nbsp;unit&nbsp;effect&nbsp;{rmem,&nbsp;rreg,&nbsp;wreg}<br>
<br>
/*&nbsp;******************************************************************&nbsp;*/<br>
<br>
/*&nbsp;ADDI&nbsp;*/<br>
<br>
union&nbsp;clause&nbsp;ast&nbsp;=&nbsp;ITYPE&nbsp;:&nbsp;(bits(12),&nbsp;regbits,&nbsp;regbits,&nbsp;iop)<br>
<br>
function&nbsp;clause&nbsp;decode&nbsp;imm&nbsp;:&nbsp;bits(12)&nbsp;@&nbsp;rs1&nbsp;:&nbsp;regbits&nbsp;@&nbsp;0b000&nbsp;@&nbsp;rd&nbsp;:&nbsp;regbits&nbsp;@&nbsp;0b0010011<br>
&nbsp;&nbsp;=&nbsp;Some(ITYPE(imm,&nbsp;rs1,&nbsp;rd,&nbsp;RISCV_ADDI))<br>
<br>
function&nbsp;clause&nbsp;execute&nbsp;(ITYPE&nbsp;(imm,&nbsp;rs1,&nbsp;rd,&nbsp;RISCV_ADDI))&nbsp;=<br>
&nbsp;&nbsp;let&nbsp;rs1_val&nbsp;=&nbsp;X(rs1)&nbsp;in<br>
&nbsp;&nbsp;let&nbsp;imm_ext&nbsp;:&nbsp;xlenbits&nbsp;=&nbsp;EXTS(imm)&nbsp;in<br>
&nbsp;&nbsp;let&nbsp;result&nbsp;=&nbsp;rs1_val&nbsp;+&nbsp;imm_ext&nbsp;in<br>
&nbsp;&nbsp;X(rd)&nbsp;=&nbsp;result<br>
<br>
/*&nbsp;******************************************************************&nbsp;*/<br>
<br>
/*&nbsp;Load&nbsp;double&nbsp;*/<br>
union&nbsp;clause&nbsp;ast&nbsp;=&nbsp;LOAD&nbsp;:&nbsp;(bits(12),&nbsp;regbits,&nbsp;regbits)<br>
<br>
function&nbsp;clause&nbsp;decode&nbsp;imm&nbsp;:&nbsp;bits(12)&nbsp;@&nbsp;rs1&nbsp;:&nbsp;regbits&nbsp;@&nbsp;0b011&nbsp;@&nbsp;rd&nbsp;:&nbsp;regbits&nbsp;@&nbsp;0b0000011<br>
&nbsp;&nbsp;=&nbsp;Some(LOAD(imm,&nbsp;rs1,&nbsp;rd))<br>
<br>
function&nbsp;clause&nbsp;execute(LOAD(imm,&nbsp;rs1,&nbsp;rd))&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;let&nbsp;addr&nbsp;:&nbsp;xlenbits&nbsp;=&nbsp;X(rs1)&nbsp;+&nbsp;EXTS(imm)&nbsp;in<br>
&nbsp;&nbsp;&nbsp;&nbsp;let&nbsp;result&nbsp;:&nbsp;xlenbits&nbsp;=&nbsp;read_mem(addr,&nbsp;sizeof(xlen_bytes))&nbsp;in<br>
&nbsp;&nbsp;&nbsp;&nbsp;X(rd)&nbsp;=&nbsp;result<br>
<br>
/*&nbsp;******************************************************************&nbsp;*/<br>
<br>
function&nbsp;clause&nbsp;decode&nbsp;_&nbsp;=&nbsp;None()<br>
<br>
</code>
</body>
</html>